# 아이템2 - 생성자에 매개변수가 많다면 빌더를 고려하라

생성자, 정적 팩토리 메서드의 제약 - 선택적 매개변수가 많을 때 적절히 대응하기 어렵다. 
이럴 때 기존에 주로 사용된 것이 **점층적 생성자 패턴**.

### 1. 점층적 생성자 패턴

[예시 코드](https://github.com/WegraLee/effective-java-3e-source-code/blob/master/src/effectivejava/chapter2/item2/telescopingconstructor/NutritionFacts.java)

`필수 매개변수만 받는 생성자`, `필수 + 선택적 매개변수 1개를 받는 생성자`, `필수 + 선택 2개` 와 같은 형태로 늘려가면서 모든 매개변수를 받는 생성자까지 만드는 방법.

**단점**
- 설정하길 원치 않는 매개변수도 설정해줘야 하는 상황이 생긴다.
- 매개변수가 많아지면 클라이언트 코드를 작성하거나 읽기 어렵다.
  - 각 값의 의미가 뭔지 헷갈림.
  - 매개변수가 몇개인지 주의깊게 봐야함.
  - 타입이 같은 매개변수 여러개가 같이 연달아 있으면 값을 잘못 전달해 컴파일러가 잡지 못하는 버그가 발생할 수 있음.

### 2. 자바빈즈 패턴

[예시 코드](https://github.com/WegraLee/effective-java-3e-source-code/blob/master/src/effectivejava/chapter2/item2/javabeans/NutritionFacts.java)

매개변수가 없는 생성자로 객체 생성 후, 원하는 값만 setter로 주입하는 방법.

`점층적 생성자 패턴`의 문제는 해결된 듯 하다. 하지만 다른 심각한 단점이 있다. **객체 하나를 만드려면 메서드를 여러 개 호출해야하고, 객체가 완전히 생성되기 전까지는 일관성이 무너진 상태에 놓이게 된다.** `점층적 생성자 패턴`에서는 매개변수들이 유효한지만 확인하면 일관성을 유지할 수 있었는데, 그 장치가 완전히 사라졌다.

**단점**
- 일관성이 깨진 객체가 만들어진다.
  - 일관성이 깨지면, 버그를 심은 코드와 그로 인해 문제가 발생하는 코드가 멀리 떨어져 있어서 디버깅이 어렵다.
- 불변으로 만들 수 없다.
  - 이로인해 스레드 안정성을 얻으려면 추가 작업을 해줘야한다.

이런 단점을 완화하기 위해 생성이 끝난 객체를 수동으로 얼리고(freezing), 얼리기 전에는 사용할 수 없도록 하는 방법도 있지만 거의 쓰이지 않는다.

### 3. 빌더 패턴

[예시 코드](https://github.com/WegraLee/effective-java-3e-source-code/blob/master/src/effectivejava/chapter2/item2/builder/NutritionFacts.java)

`점층적 생성자 패턴`의 **안정성**, `자바빈즈 패턴`의 **가독성**을 모두 갖춤.
필요한 객체를 직접 만들지 않고, 빌더 객체가 대신 만들어준다.
빌더는 생성할 클래스안에 static inner class로 만드는게 일반적이다.

1. 필수 매개변수를 통해 빌더 객체를 얻는다.
2. 빌더 객체의 setter 메서드로 원하는 선택적 매개변수들을 설정한다.
3. build 메서드를 호출하면 설정한 매개변수들을 통해 만들어진 필요한 객체가 반환된다.

- 예시 코드의 `NutritionFacts` 클래스는 불변이다.
- 모든 매개변수의 기본값은 한 곳에 모여있다.
- 빌더의 setter 메서드는 자기자신을 반환하기 때문에 연쇄적으로 호출할 수 있다(메서드 체이닝).

**빌더를 사용해 NutritionFacts의 객체를 생성하는 클라이언트 코드**
```java
NutritionFacts cocaCola = new NutritionFacts.Builder(240, 8).calories(100).sodium(35).carbonhydrate(27).build();
```

- 매우 쉽게 쓰고, 읽을 수 있다.
- 빌더 패턴은 파이썬, 스칼라의 `named optional parameter`를 흉내낸 것이다.
- 유효성 검사는 build 메서드가 호출하는 생성자에서 하는 것이 좋다.
  - 불변식을 보장하려면 빌더로부터 매개변수를 복사해서 해당 객체의 필드들도 검사해야 한다(방어적 복사).

### 3-1. 계층적 빌더 패턴

[예시 코드 - Pizza.java를 상속한 NyPizza.java, Calzone.java](https://github.com/WegraLee/effective-java-3e-source-code/tree/master/src/effectivejava/chapter2/item2/hierarchicalbuilder)

빌더 패턴은 계층적으로 설계된 클래스와 함께 쓰기에 좋다. 
추상 클래스에는 추상 빌더, 구체 클래스에는 구체 빌더를 inner class로 정의한다.

근데 아직 잘 모르겠다

### 마무리

빌더 패턴의 단점도 있다.

- 개발자가 빌더 클래스를 작성하는 비용.
- 객체 생성 전에 빌더 객체를 생성하는 컴퓨터 리소스.
  - 빌더 생성이 크진 않지만 성능에 민감하다면 문제가 될 수도.
- 매개변수 4개 이상이 되어야 값어치 함
  - 하지만 보통 시간이 지날수록 매개변수가 많아지는 경향이 있으니 처음부터 하는 것도 좋음.

> 생성자나 정적 팩토리 메서드가 처리할 매개변수가 많다면 빌더 패턴을 선택하는게 낫다. 
> 매개변수 중 다수가 필수가 아니거나, 같은 타입이면 특히 더 그렇다.
> 빌더는 점층적 생성자보다 클라이언트 코드를 읽고 쓰기가 훨씬 간결하고, 자바빈즈보다 훨씬 안전하다.

끗
