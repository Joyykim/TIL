/* malevic@0.18.0 - Feb 7, 2020 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(((t=t||self).Malevic=t.Malevic||{},t.Malevic.DOM={}))}(this,function(t){"use strict";function e(){var i=[];return{add:function(t){return i.push(t),this},apply:function(t){for(var e,n,r=new Set,o=i.length-1;0<=o;o--)if(n=i[o],!r.has(n)){if(null!=(e=n(t)))return e;r.add(n)}return null},delete:function(t){for(var e=i.length-1;0<=e;e--)if(i[e]===t){i.splice(e,1);break}return this},empty:function(){return 0===i.length}}}function n(r,t,o){t.filter(function(t){var e=t[0];return r[e]}).forEach(function(t){var e=t[0],n=t[1];return r[e].forEach(function(t){return o(n,t)})})}function r(n){var r={add:function(t,e){return t[n]||(t[n]=[]),t[n].push(e),r}};return r}var o=Symbol(),i=e();function p(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=[];return t.filter(function(t){return Boolean(t)}).forEach(function(e){"string"==typeof e?n.push(e):"object"==typeof e&&n.push.apply(n,Object.keys(e).filter(function(t){return Boolean(e[t])}))}),n.join(" ")}function c(t){return null!=t&&"object"==typeof t}var u=new WeakMap;function s(e,t){var n=new Map,r=new Set(Object.keys(e));return Object.keys(t).filter(function(t){return!r.has(t)}).forEach(function(t){return n.set(t,null)}),r.forEach(function(t){return n.set(t,e[t])}),n}function f(n,t,e){var r;c(e)?r=e:(r={},n.removeAttribute("style")),s(t,r).forEach(function(t,e){return function(t,e,n){if(null!=n&&""!==n){var r=String(n),o="";r.endsWith("!important")&&(r=r.substring(0,r.length-10),o="important"),t.style.setProperty(e,r,o)}else t.style.removeProperty(e)}(n,e,t)})}function h(t,e,n){var r,o,i,s;"function"==typeof n?(r=t,o=e,i=n,u.has(r)?s=u.get(r):(s=new Map,u.set(r,s)),s.get(o)!==i&&(s.has(o)&&r.removeEventListener(o,s.get(o)),r.addEventListener(o,i),s.set(o,i))):function(t,e){if(u.has(t)){var n=u.get(t);t.removeEventListener(e,n.get(e)),n.delete(e)}}(t,e)}var l=new Set(["key","oncreate","onupdate","onrender","onremove"]),a=Symbol(),d=e();function v(t,e){return t&&t.hasOwnProperty(e)?t[e]:null}function y(u,t,a){s(t,a||{}).forEach(function(t,e){var n,r,o;if(!d.empty()&&null!=d.apply({element:u,attr:e,value:t,get prev(){return v(a,e)}}))return;if("class"===e&&c(t))n=u,r=t,(o=Array.isArray(r)?p.apply(void 0,r):p(r))?n.setAttribute("class",o):n.removeAttribute("class");else if("style"===e&&c(t)){var i=v(a,e);f(u,t,i)}else if(e.startsWith("on")){var s=e.substring(2);h(u,s,t)}else l.has(e)||(null==t||!1===t?u.removeAttribute(e):u.setAttribute(e,!0===t?"":String(t)))})}var g=(m.prototype.empty=function(){return null==this.first},m.prototype.push=function(t){this.empty()?this.first=t:(this.nexts.set(this.last,t),this.prevs.set(t,this.last)),this.last=t},m.prototype.insertBefore=function(t,e){var n=this.before(e);this.prevs.set(t,n),this.nexts.set(t,e),this.prevs.set(e,t),n&&this.nexts.set(n,t),e===this.first&&(this.first=t)},m.prototype.delete=function(t){var e=this.before(t),n=this.after(t);e&&this.nexts.set(e,n),n&&this.prevs.set(n,e),t===this.first&&(this.first=n),t===this.last&&(this.last=e)},m.prototype.before=function(t){return this.prevs.get(t)||null},m.prototype.after=function(t){return this.nexts.get(t)||null},m.prototype.loop=function(t){if(!this.empty()){var e=this.first;do{if(t(e))break}while(e=this.after(e))}},m.prototype.copy=function(){var e=new m;return this.loop(function(t){return e.push(t),!1}),e},m.prototype.forEach=function(e){this.loop(function(t){return e(t),!1})},m.prototype.find=function(e){var n=null;return this.loop(function(t){return!!e(t)&&(n=t,!0)}),n},m.prototype.map=function(e){var n=[];return this.loop(function(t){return n.push(e(t)),!1}),n},m);function m(){for(var e=this,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];this.nexts=new WeakMap,this.prevs=new WeakMap,this.first=null,this.last=null,t.forEach(function(t){return e.push(t)})}function E(t,e,n){var r=t&&e&&t.matches(e);r&&t.parent()===e.parent()?n.replaceVNode(e,t):t&&n.addVNode(t);var o=n.getVNodeContext(t),i=n.getVNodeContext(e);if((e&&!r&&(e.detach(i),e.children().forEach(function(t){return E(null,t,n)}),e.detached(i)),t&&!r&&(t.attach(o),t.children().forEach(function(t){return E(t,null,n)}),t.attached(o)),r)&&t.update(e,o)!==n.LEAVE){var s=function(t,e){var n=e.children(),o=new Map,i=[];n.forEach(function(t){var e=t.key();null==e?i.push(t):o.set(e,t)});var r=t.children(),s=[],u=new Set(n),a=new Set;return r.forEach(function(t){var e=null,n=null,r=t.key();if(null!=r){if(a.has(r))throw new Error("Duplicate key");a.add(r),o.has(r)&&(n=o.get(r))}else 0<i.length&&(n=i.shift());t.matches(n)&&(e=n),s.push([t,e]),e&&u.delete(e)}),{matches:s,unmatched:u}}(t,e),u=s.matches;s.unmatched.forEach(function(t){return E(null,t,n)}),u.forEach(function(t){return E(t[0],t[1],n)}),t.updated(o)}}var w=function(t,e){return(w=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function x(t,e){function n(){this.constructor=t}w(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function b(t){return c(t)&&null!=t.type&&null==t.nodeType}var N=(k.prototype.key=function(){return null},k.prototype.parent=function(t){if(!t)return this.parentVNode;this.parentVNode=t},k.prototype.children=function(){return[]},k.prototype.attach=function(t){},k.prototype.detach=function(t){},k.prototype.update=function(t,e){return null},k.prototype.attached=function(t){},k.prototype.detached=function(t){},k.prototype.updated=function(t){},k);function k(t){this.parentVNode=t}function C(t,e){return t instanceof Element&&e.type===t.tagName.toLowerCase()}var V=new WeakMap;function D(t,e){var n;V.has(e)?n=V.get(e):(n=new WeakSet,V.set(e,n)),n.add(t)}function M(t,e){return V.has(e)&&V.get(e).has(t)}var S,A=(x(O,S=N),O.prototype.matches=function(t){return t instanceof O&&this.spec.type===t.spec.type},O.prototype.key=function(){return this.spec.props.key},O.prototype.children=function(){return[this.child]},O.prototype.getExistingElement=function(t){var e,n=t.parent,r=t.node;if(C(r,this.spec))e=r;else if(!M(n,t.vdom)&&t.vdom.isDOMNodeCaptured(n)){var o=t.sibling,i=o?o.nextElementSibling:n.firstElementChild;i&&!t.vdom.isDOMNodeCaptured(i)&&(C(i,this.spec)?e=i:n.removeChild(i))}return e},O.prototype.attach=function(t){var e,n=this.getExistingElement(t);n?e=n:D(e=function(t,e){var n=i.apply({spec:t,parent:e});if(n)return n;var r=t.type;return"svg"===r?document.createElementNS("http://www.w3.org/2000/svg","svg"):"http://www.w3.org/1999/xhtml"===e.namespaceURI?document.createElement(r):document.createElementNS(e.namespaceURI,r)}(this.spec,t.parent),t.vdom),y(e,this.spec.props,null),this.child=X(e,this.spec.children,this)},O.prototype.update=function(t,e){var n=e.vdom.getVNodeContext(t).node;y(n,this.spec.props,t.spec.props),this.child=X(n,this.spec.children,this)},O.prototype.attached=function(t){var e=this.spec.props,n=e.oncreate,r=e.onrender;n&&n(t.node),r&&r(t.node)},O.prototype.detached=function(t){var e=this.spec.props.onremove;e&&e(t.node)},O.prototype.updated=function(t){var e=this.spec.props,n=e.onupdate,r=e.onrender;n&&n(t.node),r&&r(t.node)},O);function O(t,e){var n=S.call(this,e)||this;return n.spec=t,n}var R,P={CREATED:Symbol(),REMOVED:Symbol(),UPDATED:Symbol(),RENDERED:Symbol()},W=[[o,i],[a,d]],j=(x(L,R=N),L.prototype.matches=function(t){return t instanceof L&&this.spec.type===t.spec.type},L.prototype.key=function(){return this.spec.props.key},L.prototype.children=function(){return[this.child]},L.prototype.createContext=function(r){var o=this,t=r.parent,e=this.spec,n=this.prev,i=this.store;return{spec:e,prev:n,store:i,get node(){return r.node},get nodes(){return r.nodes},parent:t,onCreate:function(t){return i[P.CREATED]=t},onUpdate:function(t){return i[P.UPDATED]=t},onRemove:function(t){return i[P.REMOVED]=t},onRender:function(t){return i[P.RENDERED]=t},refresh:function(){if(o.lock)throw new Error("Calling refresh during unboxing causes infinite loop");o.prev=o.spec;var t=r.vdom.getVNodeContext(o),e=o.unbox(t);if(e!==r.vdom.LEAVE){var n=o.child;o.child=tt(e,o),r.vdom.execute(o.child,n),o.updated(r)}},leave:function(){return r.vdom.LEAVE}}},L.prototype.unbox=function(t){var e=this.spec.type,n=this.spec.props,r=this.spec.children;this.lock=!0;var o=L.context;L.context=this.createContext(t);var i=null;try{i=e.apply(void 0,function(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),o=0;for(e=0;e<n;e++)for(var i=arguments[e],s=0,u=i.length;s<u;s++,o++)r[o]=i[s];return r}([n],r))}finally{L.context=o,this.lock=!1}return i},L.prototype.addPlugins=function(){n(this.spec.type,W,function(t,e){return t.add(e)})},L.prototype.deletePlugins=function(){n(this.spec.type,W,function(t,e){return t.delete(e)})},L.prototype.attach=function(t){this.addPlugins();var e=this.unbox(t),n=e===t.vdom.LEAVE?null:e;this.child=tt(n,this)},L.prototype.update=function(t,e){this.store=t.store,this.prev=t.spec;var n=e.vdom.getVNodeContext(t);this.addPlugins();var r=this.unbox(n),o=null;return r===e.vdom.LEAVE?(o=r,this.child=t.child,e.vdom.adoptVNode(this.child,this)):this.child=tt(r,this),o},L.prototype.handle=function(t,e){var n=this.store[t];if(n){var r=0===e.nodes.length?[null]:e.nodes;n.apply(void 0,r)}},L.prototype.attached=function(t){this.deletePlugins(),this.handle(P.CREATED,t),this.handle(P.RENDERED,t)},L.prototype.detached=function(t){this.handle(P.REMOVED,t)},L.prototype.updated=function(t){this.deletePlugins(),this.handle(P.UPDATED,t),this.handle(P.RENDERED,t)},L.context=null,L);function L(t,e){var n=R.call(this,e)||this;return n.lock=!1,n.spec=t,n.prev=null,n.store={},n}var T,_=(x(U,T=N),U.prototype.matches=function(t){return t instanceof U},U.prototype.children=function(){return[this.child]},U.prototype.getExistingNode=function(t){var e,n=t.parent;if(t.node instanceof Text)e=t.node;else if(!M(n,t.vdom)&&t.vdom.isDOMNodeCaptured(n)){var r=t.sibling,o=r?r.nextSibling:n.firstChild;o&&!t.vdom.isDOMNodeCaptured(o)&&o instanceof Text&&(e=o)}return e},U.prototype.attach=function(t){var e,n=this.getExistingNode(t);n?(e=n).textContent=this.text:e=document.createTextNode(this.text),this.child=tt(e,this)},U.prototype.update=function(t,e){var n=e.vdom.getVNodeContext(t).node;this.text!==t.text&&(n.textContent=this.text),this.child=tt(n,this)},U);function U(t,e){var n=T.call(this,e)||this;return n.text=t,n}var B,I=(x(F,B=N),F.prototype.matches=function(t){return t instanceof F},F.prototype.children=function(){return[this.child]},F.prototype.call=function(t){var e=(0,this.fn)({parent:t.parent,get node(){return t.node},get nodes(){return t.nodes}});this.child=tt(e,this)},F.prototype.attach=function(t){this.call(t)},F.prototype.update=function(t,e){var n=e.vdom.getVNodeContext(t);this.call(n)},F);function F(t,e){var n=B.call(this,e)||this;return n.fn=t,n}var q,z=(x(G,q=N),G.prototype.matches=function(t){return t instanceof G},G);function G(){return null!==q&&q.apply(this,arguments)||this}var H,J=(x(K,H=N),K.prototype.matches=function(t){return t instanceof K&&this.node===t.node},K.prototype.wrap=function(){var e=this;this.childVNodes=this.childSpecs.map(function(t){return tt(t,e)})},K.prototype.insertNode=function(t){var e=t.parent,n=t.sibling;if(e!==this.node.parentElement||n!==this.node.previousSibling){var r=n?n.nextSibling:e.firstChild;e.insertBefore(this.node,r)}},K.prototype.attach=function(t){this.wrap(),this.insertNode(t)},K.prototype.detach=function(t){t.parent.removeChild(this.node)},K.prototype.update=function(t,e){this.wrap(),this.insertNode(e)},K.prototype.refine=function(t){for(var e=this.node,n=e.lastChild;null!=n;)if(t.vdom.isDOMNodeCaptured(n))n=n.previousSibling;else{var r=n.previousSibling;e.removeChild(n),n=r}D(e,t.vdom)},K.prototype.attached=function(t){var e=this.node;e instanceof Element&&!M(e,t.vdom)&&t.vdom.isDOMNodeCaptured(e)&&this.refine(t)},K.prototype.children=function(){return this.childVNodes},K);function K(t,e,n){var r=H.call(this,n)||this;return r.node=t,r.childSpecs=e,r}function Q(t){return t instanceof J}function X(t,e,n){return new J(t,e,n)}var Y,Z=(x($,Y=N),$.prototype.matches=function(t){return t instanceof $},$.prototype.key=function(){return this.id},$.prototype.children=function(){return this.childVNodes},$.prototype.wrap=function(){var e=this;this.childVNodes=this.items.map(function(t){return tt(t,e)})},$.prototype.attach=function(){this.wrap()},$.prototype.update=function(){this.wrap()},$);function $(t,e,n){var r=Y.call(this,n)||this;return r.items=t,r.id=e,r}function tt(t,e){if(b(n=t)&&"string"==typeof n.type)return new A(t,e);var n,r;if(b(r=t)&&"function"==typeof r.type)return t.type===Array?new Z(t.children,t.props.key,e):new j(t,e);if("string"==typeof t)return new _(t,e);if(null==t)return new z(e);if("function"==typeof t)return new I(t,e);if(t instanceof Node)return X(t,[],e);if(Array.isArray(t))return new Z(t,null,e);throw new Error("Unable to create virtual node for spec")}function et(o){var s=new WeakMap,u=new WeakMap,a=new WeakMap,p=new WeakMap,c=new WeakSet;function f(n){var r=a.get(n);s.set(n,{parent:r,get node(){var t=p.get(n).find(function(t){return null!=t.node});return t?t.node:null},get nodes(){return p.get(n).map(function(t){return t.node}).filter(function(t){return t})},get sibling(){if(r===o.parentElement)return p.get(n).first.node.previousSibling;for(var t=u.get(r),e=p.get(n).first;e=t.links.before(e);)if(e.node)return e.node;return null},vdom:i})}function h(t){var e,n,r;null==t.parent()?(e=t,n=o.parentElement||document.createDocumentFragment(),r=new g({parentNode:n,node:o}),p.set(e,r.copy()),a.set(e,n),u.set(n,{node:n,links:r})):function(t){var e=t.parent(),n=c.has(e),r=Q(e)?e.node:a.get(e);a.set(t,r);var o=new g;if(p.set(t,o),n){for(var i={parentNode:r,node:null},s=t;p.get(s).push(i),(s=s.parent())&&!Q(s););u.get(r).links.push(i)}else{c.add(e),(Q(e)?u.get(r).links:p.get(e)).forEach(function(t){return o.push(t)})}}(t),function(t){if(Q(t)){var e=t.node;u.set(e,{node:e,links:new g({parentNode:e,node:null})}),p.get(t).forEach(function(t){return t.node=e})}}(t),f(t)}function l(t){for(var e=a.get(t),n=u.get(e),r=[],o=t;(o=o.parent())&&!Q(o);)r.push(p.get(o));return r.push(n.links),r}var i={execute:function(t,e){E(t,e,i)},addVNode:h,getVNodeContext:function(t){return s.get(t)},replaceVNode:function(t,e){if(null!=e.parent()){var n=s.get(t).parent;a.set(e,n);var r=p.get(t),o={parentNode:n,node:null};l(e).forEach(function(e){var t=e.after(r.last);r.forEach(function(t){return e.delete(t)}),t?e.insertBefore(o,t):e.push(o)});var i=new g(o);p.set(e,i),f(e)}else h(e)},adoptVNode:function(t,e){var n=p.get(t),r=p.get(e).copy();t.parent(e),l(t).forEach(function(e){n.forEach(function(t){return e.insertBefore(t,r.first)}),r.forEach(function(t){return e.delete(t)})})},isDOMNodeCaptured:function(t){return u.has(t)&&t!==o.parentElement},LEAVE:Symbol()};return i}var nt=new WeakMap,rt=new WeakMap;function ot(t,e){var n,r=nt.get(t)||null;return nt.set(t,e),rt.has(t)?n=rt.get(t):(n=et(t),rt.set(t,n)),n.execute(e,r),n.getVNodeContext(e)}var it={createElement:r(o),setAttribute:r(a)};t.getContext=function(){return j.context},t.plugins=it,t.render=function(t,e){return ot(t,X(t,Array.isArray(e)?e:[e],null)),t},t.sync=function(t,e){var n=ot(t,tt(e,null)).nodes;if(1!==n.length||n[0]!==t)throw new Error("Spec does not match the node");return n[0]},t.teardown=function(t){nt.delete(t),rt.delete(t)},Object.defineProperty(t,"__esModule",{value:!0})});
