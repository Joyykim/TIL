var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _highlight=_interopRequireDefault(require("highlight.js"));var _marked=_interopRequireDefault(require("marked"));var hljsCSS="/*\n\ngithub.com style (c) Vasily Polovnyov <vast@whiteants.net>\n\n*/\n\n.hljs {\n  display: block;\n  overflow-x: auto;\n  padding: 0.5em;\n  color: #333;\n  background: #f8f8f8;\n}\n\n.hljs-comment,\n.hljs-quote {\n  color: #998;\n  font-style: italic;\n}\n\n.hljs-keyword,\n.hljs-selector-tag,\n.hljs-subst {\n  color: #333;\n  font-weight: bold;\n}\n\n.hljs-number,\n.hljs-literal,\n.hljs-variable,\n.hljs-template-variable,\n.hljs-tag .hljs-attr {\n  color: #008080;\n}\n\n.hljs-string,\n.hljs-doctag {\n  color: #d14;\n}\n\n.hljs-title,\n.hljs-section,\n.hljs-selector-id {\n  color: #900;\n  font-weight: bold;\n}\n\n.hljs-subst {\n  font-weight: normal;\n}\n\n.hljs-type,\n.hljs-class .hljs-title {\n  color: #458;\n  font-weight: bold;\n}\n\n.hljs-tag,\n.hljs-name,\n.hljs-attribute {\n  color: #000080;\n  font-weight: normal;\n}\n\n.hljs-regexp,\n.hljs-link {\n  color: #009926;\n}\n\n.hljs-symbol,\n.hljs-bullet {\n  color: #990073;\n}\n\n.hljs-built_in,\n.hljs-builtin-name {\n  color: #0086b3;\n}\n\n.hljs-meta {\n  color: #999;\n  font-weight: bold;\n}\n\n.hljs-deletion {\n  background: #fdd;\n}\n\n.hljs-addition {\n  background: #dfd;\n}\n\n.hljs-emphasis {\n  font-style: italic;\n}\n\n.hljs-strong {\n  font-weight: bold;\n}\n";var baseCSS="/*! normalize.css v4.1.1 | MIT License | github.com/necolas/normalize.css */html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section{display:block}summary{display:list-item}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}template,[hidden]{display:none !important}a{background-color:transparent}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit}b,strong{font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:0.67em 0}mark{background-color:#ff0;color:#1b1f23}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-0.25em}sup{top:-0.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace, monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,select,textarea{font:inherit;margin:0}optgroup{font-weight:600}button,input{overflow:visible}button,select{text-transform:none}button,html [type=\"button\"],[type=\"reset\"],[type=\"submit\"]{-webkit-appearance:button}button::-moz-focus-inner,[type=\"button\"]::-moz-focus-inner,[type=\"reset\"]::-moz-focus-inner,[type=\"submit\"]::-moz-focus-inner{border-style:none;padding:0}button:-moz-focusring,[type=\"button\"]:-moz-focusring,[type=\"reset\"]:-moz-focusring,[type=\"submit\"]:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:0.35em 0.625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=\"checkbox\"],[type=\"radio\"]{box-sizing:border-box;padding:0}[type=\"number\"]::-webkit-inner-spin-button,[type=\"number\"]::-webkit-outer-spin-button{height:auto}[type=\"search\"]{-webkit-appearance:textfield;outline-offset:-2px}[type=\"search\"]::-webkit-search-cancel-button,[type=\"search\"]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:0.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}*{box-sizing:border-box}input,select,textarea,button{font-family:inherit;font-size:inherit;line-height:inherit}body{font-family:-apple-system,BlinkMacSystemFont,\"Segoe UI\",Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\";font-size:14px;line-height:1.5;color:#24292e;background-color:#fff}a{color:#0366d6;text-decoration:none}a:hover{text-decoration:underline}b,strong{font-weight:600}hr,.rule{height:0;margin:15px 0;overflow:hidden;background:transparent;border:0;border-bottom:1px solid #dfe2e5}hr::before,.rule::before{display:table;content:\"\"}hr::after,.rule::after{display:table;clear:both;content:\"\"}table{border-spacing:0;border-collapse:collapse}td,th{padding:0}button{cursor:pointer;border-radius:0}[hidden][hidden]{display:none !important}details summary{cursor:pointer}details:not([open])>*:not(summary){display:none !important}kbd{display:inline-block;padding:3px 5px;font:11px \"SFMono-Regular\",Consolas,\"Liberation Mono\",Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:solid 1px #d1d5da;border-bottom-color:#d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:0}h1{font-size:32px;font-weight:600}h2{font-size:24px;font-weight:600}h3{font-size:20px;font-weight:600}h4{font-size:16px;font-weight:600}h5{font-size:14px;font-weight:600}h6{font-size:12px;font-weight:600}p{margin-top:0;margin-bottom:10px}small{font-size:90%}blockquote{margin:0}ul,ol{padding-left:0;margin-top:0;margin-bottom:0}ol ol,ul ol{list-style-type:lower-roman}ul ul ol,ul ol ol,ol ul ol,ol ol ol{list-style-type:lower-alpha}dd{margin-left:0}tt,code{font-family:\"SFMono-Regular\",Consolas,\"Liberation Mono\",Menlo,monospace;font-size:12px}pre{margin-top:0;margin-bottom:0;font-family:\"SFMono-Regular\",Consolas,\"Liberation Mono\",Menlo,monospace;font-size:12px}.octicon{vertical-align:text-bottom}\n\n/*# sourceMappingURL=base.css.map */";var mdCSS=".markdown-body{font-family:-apple-system,BlinkMacSystemFont,\"Segoe UI\",Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\";font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px \"SFMono-Regular\",Consolas,\"Liberation Mono\",Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:solid 1px #d1d5da;border-bottom-color:#d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body::before{display:table;content:\"\"}.markdown-body::after{display:table;clear:both;content:\"\"}.markdown-body>*:first-child{margin-top:0 !important}.markdown-body>*:last-child{margin-bottom:0 !important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body .absent{color:#cb2431}.markdown-body .anchor{float:left;padding-right:4px;margin-left:-20px;line-height:1}.markdown-body .anchor:focus{outline:none}.markdown-body p,.markdown-body blockquote,.markdown-body ul,.markdown-body ol,.markdown-body dl,.markdown-body table,.markdown-body pre,.markdown-body details{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:0.25em solid #dfe2e5}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1 tt,.markdown-body h1 code,.markdown-body h2 tt,.markdown-body h2 code,.markdown-body h3 tt,.markdown-body h3 code,.markdown-body h4 tt,.markdown-body h4 code,.markdown-body h5 tt,.markdown-body h5 code,.markdown-body h6 tt,.markdown-body h6 code{font-size:inherit}.markdown-body h1{padding-bottom:0.3em;font-size:2em;border-bottom:1px solid #eaecef}.markdown-body h2{padding-bottom:0.3em;font-size:1.5em;border-bottom:1px solid #eaecef}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:0.875em}.markdown-body h6{font-size:0.85em;color:#6a737d}.markdown-body ul,.markdown-body ol{padding-left:2em}.markdown-body ul.no-list,.markdown-body ol.no-list{padding:0;list-style-type:none}.markdown-body ul ul,.markdown-body ul ol,.markdown-body ol ol,.markdown-body ol ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li>p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table th,.markdown-body table td{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body table img{background-color:transparent}.markdown-body img{max-width:100%;box-sizing:content-box;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body .emoji{max-width:none;vertical-align:text-top;background-color:transparent}.markdown-body span.frame{display:block;overflow:hidden}.markdown-body span.frame>span{display:block;float:left;width:auto;padding:7px;margin:13px 0 0;overflow:hidden;border:1px solid #dfe2e5}.markdown-body span.frame span img{display:block;float:left}.markdown-body span.frame span span{display:block;padding:5px 0 0;clear:both;color:#24292e}.markdown-body span.align-center{display:block;overflow:hidden;clear:both}.markdown-body span.align-center>span{display:block;margin:13px auto 0;overflow:hidden;text-align:center}.markdown-body span.align-center span img{margin:0 auto;text-align:center}.markdown-body span.align-right{display:block;overflow:hidden;clear:both}.markdown-body span.align-right>span{display:block;margin:13px 0 0;overflow:hidden;text-align:right}.markdown-body span.align-right span img{margin:0;text-align:right}.markdown-body span.float-left{display:block;float:left;margin-right:13px;overflow:hidden}.markdown-body span.float-left span{margin:13px 0 0}.markdown-body span.float-right{display:block;float:right;margin-left:13px;overflow:hidden}.markdown-body span.float-right>span{display:block;margin:13px auto 0;overflow:hidden;text-align:right}.markdown-body code,.markdown-body tt{padding:0.2em 0.4em;margin:0;font-size:85%;background-color:rgba(27,31,35,0.05);border-radius:3px}.markdown-body code br,.markdown-body tt br{display:none}.markdown-body del code{text-decoration:inherit}.markdown-body pre{word-wrap:normal}.markdown-body pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code,.markdown-body pre tt{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}.markdown-body .csv-data td,.markdown-body .csv-data th{padding:5px;overflow:hidden;font-size:12px;line-height:1;text-align:left;white-space:nowrap}.markdown-body .csv-data .blob-num{padding:10px 8px 9px;text-align:right;background:#fff;border:0}.markdown-body .csv-data tr{border-top:0}.markdown-body .csv-data th{font-weight:600;background:#f6f8fa;border-top:0}\n\n/*# sourceMappingURL=markdown.css.map */";var bodyCSS=".markdown-body {\n  box-sizing: border-box;\n  min-width: 200px;\n  max-width: 980px;\n  margin: 0 auto;\n  padding: 45px;\n}\n\n@media screen and (max-width: 480px) {\n  .markdown-body {\n    padding: 20px;\n  }\n}\n";var darkreader="/**\n * Dark Reader v4.9.2\n * https://darkreader.org/\n */\n\n(function (global, factory) {\n    typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports) :\n    typeof define === 'function' && define.amd ? define(['exports'], factory) :\n    (global = global || self, factory(global.DarkReader = {}));\n}(this, (function (exports) { 'use strict';\n\n    /*! *****************************************************************************\r\n    Copyright (c) Microsoft Corporation. All rights reserved.\r\n    Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use\r\n    this file except in compliance with the License. You may obtain a copy of the\r\n    License at http://www.apache.org/licenses/LICENSE-2.0\r\n\r\n    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\n    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED\r\n    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,\r\n    MERCHANTABLITY OR NON-INFRINGEMENT.\r\n\r\n    See the Apache Version 2.0 License for specific language governing permissions\r\n    and limitations under the License.\r\n    ***************************************************************************** */\r\n\r\n    var __assign = function() {\r\n        __assign = Object.assign || function __assign(t) {\r\n            for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n                s = arguments[i];\r\n                for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\r\n            }\r\n            return t;\r\n        };\r\n        return __assign.apply(this, arguments);\r\n    };\r\n\r\n    function __awaiter(thisArg, _arguments, P, generator) {\r\n        return new (P || (P = Promise))(function (resolve, reject) {\r\n            function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n            function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n            function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\r\n            step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n        });\r\n    }\r\n\r\n    function __generator(thisArg, body) {\r\n        var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n        return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n        function verb(n) { return function (v) { return step([n, v]); }; }\r\n        function step(op) {\r\n            if (f) throw new TypeError(\"Generator is already executing.\");\r\n            while (_) try {\r\n                if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\r\n                if (y = 0, t) op = [op[0] & 2, t.value];\r\n                switch (op[0]) {\r\n                    case 0: case 1: t = op; break;\r\n                    case 4: _.label++; return { value: op[1], done: false };\r\n                    case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                    case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                    default:\r\n                        if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                        if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                        if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                        if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                        if (t[2]) _.ops.pop();\r\n                        _.trys.pop(); continue;\r\n                }\r\n                op = body.call(thisArg, _);\r\n            } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n            if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n        }\r\n    }\n\n    function isFirefox() {\r\n        return navigator.userAgent.includes('Firefox');\r\n    }\r\n    function isMacOS() {\r\n        return navigator.platform.toLowerCase().startsWith('mac');\r\n    }\r\n    function isDeepSelectorSupported() {\r\n        try {\r\n            document.querySelector('x /deep/ x');\r\n            return true;\r\n        }\r\n        catch (err) {\r\n            return false;\r\n        }\r\n    }\r\n    function isHostSelectorSupported() {\r\n        try {\r\n            document.querySelector(':host x');\r\n            return true;\r\n        }\r\n        catch (err) {\r\n            return false;\r\n        }\r\n    }\r\n    function isDefinedSelectorSupported() {\r\n        try {\r\n            document.querySelector(':defined');\r\n            return true;\r\n        }\r\n        catch (err) {\r\n            return false;\r\n        }\r\n    }\n\n    function getOKResponse(url, mimeType) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var response;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4, fetch(url, {\r\n                            cache: 'force-cache',\r\n                            credentials: 'omit',\r\n                        })];\r\n                    case 1:\r\n                        response = _a.sent();\r\n                        if (isFirefox() && mimeType === 'text/css' && url.startsWith('moz-extension://') && url.endsWith('.css')) {\r\n                            return [2, response];\r\n                        }\r\n                        if (mimeType && !response.headers.get('Content-Type').startsWith(mimeType)) {\r\n                            throw new Error(\"Mime type mismatch when loading \" + url);\r\n                        }\r\n                        if (!response.ok) {\r\n                            throw new Error(\"Unable to load \" + url + \" \" + response.status + \" \" + response.statusText);\r\n                        }\r\n                        return [2, response];\r\n                }\r\n            });\r\n        });\r\n    }\r\n    function loadAsDataURL(url, mimeType) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var response;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4, getOKResponse(url, mimeType)];\r\n                    case 1:\r\n                        response = _a.sent();\r\n                        return [4, readResponseAsDataURL(response)];\r\n                    case 2: return [2, _a.sent()];\r\n                }\r\n            });\r\n        });\r\n    }\r\n    function readResponseAsDataURL(response) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var blob, dataURL;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4, response.blob()];\r\n                    case 1:\r\n                        blob = _a.sent();\r\n                        return [4, (new Promise(function (resolve) {\r\n                                var reader = new FileReader();\r\n                                reader.onloadend = function () { return resolve(reader.result); };\r\n                                reader.readAsDataURL(blob);\r\n                            }))];\r\n                    case 2:\r\n                        dataURL = _a.sent();\r\n                        return [2, dataURL];\r\n                }\r\n            });\r\n        });\r\n    }\n\n    var throwCORSError = function (url) { return __awaiter(void 0, void 0, void 0, function () {\r\n        return __generator(this, function (_a) {\r\n            return [2, Promise.reject(new Error([\r\n                    'Embedded Dark Reader cannot access a cross-origin resource',\r\n                    url,\r\n                    'Overview your URLs and CORS policies or use',\r\n                    '`DarkReader.setFetchMethod(fetch: (url) => Promise<Response>))`.',\r\n                    'See if using `DarkReader.setFetchMethod(window.fetch)`',\r\n                    'before `DarkReader.enable()` works.'\r\n                ].join(' ')))];\r\n        });\r\n    }); };\r\n    var fetcher = throwCORSError;\r\n    function setFetchMethod(fetch) {\r\n        if (fetch) {\r\n            fetcher = fetch;\r\n        }\r\n        else {\r\n            fetcher = throwCORSError;\r\n        }\r\n    }\r\n    function callFetchMethod(url) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4, fetcher(url)];\r\n                    case 1: return [2, _a.sent()];\r\n                }\r\n            });\r\n        });\r\n    }\n\n    if (!window.chrome) {\r\n        window.chrome = {};\r\n    }\r\n    if (!chrome.runtime) {\r\n        chrome.runtime = {};\r\n    }\r\n    var messageListeners = new Set();\r\n    function sendMessage() {\r\n        var args = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            args[_i] = arguments[_i];\r\n        }\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var id_1, _a, url, responseType, response, text_1, error_1;\r\n            return __generator(this, function (_b) {\r\n                switch (_b.label) {\r\n                    case 0:\r\n                        if (!(args[0] && args[0].type === 'fetch')) return [3, 8];\r\n                        id_1 = args[0].id;\r\n                        _b.label = 1;\r\n                    case 1:\r\n                        _b.trys.push([1, 7, , 8]);\r\n                        _a = args[0].data, url = _a.url, responseType = _a.responseType;\r\n                        return [4, callFetchMethod(url)];\r\n                    case 2:\r\n                        response = _b.sent();\r\n                        if (!(responseType === 'data-url')) return [3, 4];\r\n                        return [4, readResponseAsDataURL(response)];\r\n                    case 3:\r\n                        text_1 = _b.sent();\r\n                        return [3, 6];\r\n                    case 4: return [4, response.text()];\r\n                    case 5:\r\n                        text_1 = _b.sent();\r\n                        _b.label = 6;\r\n                    case 6:\r\n                        messageListeners.forEach(function (cb) { return cb({ type: 'fetch-response', data: text_1, error: null, id: id_1 }); });\r\n                        return [3, 8];\r\n                    case 7:\r\n                        error_1 = _b.sent();\r\n                        console.error(error_1);\r\n                        messageListeners.forEach(function (cb) { return cb({ type: 'fetch-response', data: null, error: error_1, id: id_1 }); });\r\n                        return [3, 8];\r\n                    case 8: return [2];\r\n                }\r\n            });\r\n        });\r\n    }\r\n    function addMessageListener(callback) {\r\n        messageListeners.add(callback);\r\n    }\r\n    if (typeof chrome.runtime.sendMessage === 'function') {\r\n        var nativeSendMessage_1 = chrome.runtime.sendMessage;\r\n        chrome.runtime.sendMessage = function () {\r\n            var args = [];\r\n            for (var _i = 0; _i < arguments.length; _i++) {\r\n                args[_i] = arguments[_i];\r\n            }\r\n            sendMessage.apply(void 0, args);\r\n            nativeSendMessage_1.apply(chrome.runtime, args);\r\n        };\r\n    }\r\n    else {\r\n        chrome.runtime.sendMessage = sendMessage;\r\n    }\r\n    if (!chrome.runtime.onMessage) {\r\n        chrome.runtime.onMessage = {};\r\n    }\r\n    if (typeof chrome.runtime.onMessage.addListener === 'function') {\r\n        var nativeAddListener_1 = chrome.runtime.onMessage.addListener;\r\n        chrome.runtime.onMessage.addListener = function () {\r\n            var args = [];\r\n            for (var _i = 0; _i < arguments.length; _i++) {\r\n                args[_i] = arguments[_i];\r\n            }\r\n            addMessageListener.apply(void 0, args);\r\n            nativeAddListener_1.apply(chrome.runtime.onMessage, args);\r\n        };\r\n    }\r\n    else {\r\n        chrome.runtime.onMessage.addListener = addMessageListener;\r\n    }\n\n    var ThemeEngines = {\r\n        cssFilter: 'cssFilter',\r\n        svgFilter: 'svgFilter',\r\n        staticTheme: 'staticTheme',\r\n        dynamicTheme: 'dynamicTheme',\r\n    };\n\n    function parseURL(url) {\r\n        var a = document.createElement('a');\r\n        a.href = url;\r\n        return a;\r\n    }\r\n    function getAbsoluteURL($base, $relative) {\r\n        if ($relative.match(/^.*?\\/\\//) || $relative.match(/^data\\:/)) {\r\n            if ($relative.startsWith('//')) {\r\n                return \"\" + location.protocol + $relative;\r\n            }\r\n            return $relative;\r\n        }\r\n        var b = parseURL($base);\r\n        if ($relative.startsWith('/')) {\r\n            var u_1 = parseURL(b.protocol + \"//\" + b.host + $relative);\r\n            return u_1.href;\r\n        }\r\n        var pathParts = b.pathname.split('/').concat($relative.split('/')).filter(function (p) { return p; });\r\n        var backwardIndex;\r\n        while ((backwardIndex = pathParts.indexOf('..')) > 0) {\r\n            pathParts.splice(backwardIndex - 1, 2);\r\n        }\r\n        var u = parseURL(b.protocol + \"//\" + b.host + \"/\" + pathParts.join('/'));\r\n        return u.href;\r\n    }\n\n    function logInfo() {\r\n        var args = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            args[_i] = arguments[_i];\r\n        }\r\n    }\r\n    function logWarn() {\r\n        var args = [];\r\n        for (var _i = 0; _i < arguments.length; _i++) {\r\n            args[_i] = arguments[_i];\r\n        }\r\n    }\n\n    function iterateCSSRules(rules, iterate) {\r\n        Array.from(rules)\r\n            .forEach(function (rule) {\r\n            if (rule instanceof CSSMediaRule) {\r\n                var media = Array.from(rule.media);\r\n                if (media.includes('screen') || media.includes('all') || !(media.includes('print') || media.includes('speech'))) {\r\n                    iterateCSSRules(rule.cssRules, iterate);\r\n                }\r\n            }\r\n            else if (rule instanceof CSSStyleRule) {\r\n                iterate(rule);\r\n            }\r\n            else if (rule instanceof CSSImportRule) {\r\n                try {\r\n                    iterateCSSRules(rule.styleSheet.cssRules, iterate);\r\n                }\r\n                catch (err) {\r\n                    logWarn(err);\r\n                }\r\n            }\r\n            else {\r\n                logWarn(\"CSSRule type not supported\", rule);\r\n            }\r\n        });\r\n    }\r\n    function iterateCSSDeclarations(style, iterate) {\r\n        Array.from(style).forEach(function (property) {\r\n            var value = style.getPropertyValue(property).trim();\r\n            if (!value) {\r\n                return;\r\n            }\r\n            iterate(property, value);\r\n        });\r\n    }\r\n    function isCSSVariable(property) {\r\n        return property.startsWith('--') && !property.startsWith('--darkreader');\r\n    }\r\n    function getCSSVariables(rules) {\r\n        var variables = new Map();\r\n        rules && iterateCSSRules(rules, function (rule) {\r\n            rule.style && iterateCSSDeclarations(rule.style, function (property, value) {\r\n                if (isCSSVariable(property)) {\r\n                    variables.set(property, value);\r\n                }\r\n            });\r\n        });\r\n        return variables;\r\n    }\r\n    function getElementCSSVariables(element) {\r\n        var variables = new Map();\r\n        iterateCSSDeclarations(element.style, function (property, value) {\r\n            if (isCSSVariable(property)) {\r\n                variables.set(property, value);\r\n            }\r\n        });\r\n        return variables;\r\n    }\r\n    var cssURLRegex = /url\\((('.+?')|(\".+?\")|([^\\)]*?))\\)/g;\r\n    var cssImportRegex = /@import (url\\()?(('.+?')|(\".+?\")|([^\\)]*?))\\)?;?/g;\r\n    function getCSSURLValue(cssURL) {\r\n        return cssURL.replace(/^url\\((.*)\\)$/, '$1').replace(/^\"(.*)\"$/, '$1').replace(/^'(.*)'$/, '$1');\r\n    }\r\n    function getCSSBaseBath(url) {\r\n        var cssURL = parseURL(url);\r\n        return cssURL.protocol + \"//\" + cssURL.host + cssURL.pathname.replace(/\\?.*$/, '').replace(/(\\/)([^\\/]+)$/i, '$1');\r\n    }\r\n    function replaceCSSRelativeURLsWithAbsolute($css, cssBasePath) {\r\n        return $css.replace(cssURLRegex, function (match) {\r\n            var pathValue = getCSSURLValue(match);\r\n            return \"url(\\\"\" + getAbsoluteURL(cssBasePath, pathValue) + \"\\\")\";\r\n        });\r\n    }\r\n    var cssCommentsRegex = /\\/\\*[\\s\\S]*?\\*\\//g;\r\n    function removeCSSComments($css) {\r\n        return $css.replace(cssCommentsRegex, '');\r\n    }\r\n    var fontFaceRegex = /@font-face\\s*{[^}]*}/g;\r\n    function replaceCSSFontFace($css) {\r\n        return $css.replace(fontFaceRegex, '');\r\n    }\r\n    var varRegex = /var\\((--[^\\s,]+),?\\s*([^\\(\\)]*(\\([^\\(\\)]*\\)[^\\(\\)]*)*\\s*)\\)/g;\r\n    function replaceCSSVariables(value, variables) {\r\n        var missing = false;\r\n        var result = value.replace(varRegex, function (match, name, fallback) {\r\n            if (variables.has(name)) {\r\n                return variables.get(name);\r\n            }\r\n            else if (fallback) {\r\n                return fallback;\r\n            }\r\n            else {\r\n                logWarn(\"Variable \" + name + \" not found\");\r\n                missing = true;\r\n            }\r\n            return match;\r\n        });\r\n        if (missing) {\r\n            return result;\r\n        }\r\n        if (result.match(varRegex)) {\r\n            return replaceCSSVariables(result, variables);\r\n        }\r\n        return result;\r\n    }\n\n    function throttle(callback) {\r\n        var pending = false;\r\n        var frameId = null;\r\n        var lastArgs;\r\n        var throttled = (function () {\r\n            var args = [];\r\n            for (var _i = 0; _i < arguments.length; _i++) {\r\n                args[_i] = arguments[_i];\r\n            }\r\n            lastArgs = args;\r\n            if (frameId) {\r\n                pending = true;\r\n            }\r\n            else {\r\n                callback.apply(void 0, lastArgs);\r\n                frameId = requestAnimationFrame(function () {\r\n                    frameId = null;\r\n                    if (pending) {\r\n                        callback.apply(void 0, lastArgs);\r\n                        pending = false;\r\n                    }\r\n                });\r\n            }\r\n        });\r\n        var cancel = function () {\r\n            cancelAnimationFrame(frameId);\r\n            pending = false;\r\n            frameId = null;\r\n        };\r\n        return Object.assign(throttled, { cancel: cancel });\r\n    }\r\n    function createAsyncTasksQueue() {\r\n        var tasks = [];\r\n        var frameId = null;\r\n        function runTasks() {\r\n            var task;\r\n            while (task = tasks.shift()) {\r\n                task();\r\n            }\r\n            frameId = null;\r\n        }\r\n        function add(task) {\r\n            tasks.push(task);\r\n            if (!frameId) {\r\n                frameId = requestAnimationFrame(runTasks);\r\n            }\r\n        }\r\n        function cancel() {\r\n            tasks.splice(0);\r\n            cancelAnimationFrame(frameId);\r\n            frameId = null;\r\n        }\r\n        return { add: add, cancel: cancel };\r\n    }\n\n    function getDuration(time) {\r\n        var duration = 0;\r\n        if (time.seconds) {\r\n            duration += time.seconds * 1000;\r\n        }\r\n        if (time.minutes) {\r\n            duration += time.minutes * 60 * 1000;\r\n        }\r\n        if (time.hours) {\r\n            duration += time.hours * 60 * 60 * 1000;\r\n        }\r\n        if (time.days) {\r\n            duration += time.days * 24 * 60 * 60 * 1000;\r\n        }\r\n        return duration;\r\n    }\n\n    function removeNode(node) {\r\n        node && node.parentNode && node.parentNode.removeChild(node);\r\n    }\r\n    function watchForNodePosition(node, _a) {\r\n        var _b = _a.onRestore, onRestore = _b === void 0 ? Function.prototype : _b, _c = _a.watchParent, watchParent = _c === void 0 ? true : _c, _d = _a.watchSibling, watchSibling = _d === void 0 ? false : _d;\r\n        var MAX_ATTEMPTS_COUNT = 10;\r\n        var ATTEMPTS_INTERVAL = getDuration({ seconds: 10 });\r\n        var prevSibling = node.previousSibling;\r\n        var parent = node.parentNode;\r\n        if (!parent) {\r\n            logWarn('Unable to watch for node position: parent element not found', node, prevSibling);\r\n            return { stop: Function.prototype };\r\n        }\r\n        var attempts = 0;\r\n        var start = null;\r\n        var restore = throttle(function () {\r\n            attempts++;\r\n            var now = Date.now();\r\n            if (start == null) {\r\n                start = now;\r\n            }\r\n            else if (attempts >= MAX_ATTEMPTS_COUNT) {\r\n                if (now - start < ATTEMPTS_INTERVAL) {\r\n                    logWarn('Node position watcher stopped: some script conflicts with Dark Reader and can cause high CPU usage', node, prevSibling);\r\n                    stop();\r\n                    return;\r\n                }\r\n                start = now;\r\n                attempts = 1;\r\n            }\r\n            if (prevSibling && prevSibling.parentNode !== parent) {\r\n                logWarn('Unable to restore node position: sibling was removed', node, prevSibling, parent);\r\n                stop();\r\n                return;\r\n            }\r\n            logWarn('Node was removed, restoring it\\'s position', node, prevSibling, parent);\r\n            parent.insertBefore(node, prevSibling ? prevSibling.nextSibling : parent.firstChild);\r\n            onRestore && onRestore();\r\n        });\r\n        var observer = new MutationObserver(function () {\r\n            if ((watchParent && !node.parentNode) ||\r\n                (watchSibling && node.previousSibling !== prevSibling)) {\r\n                restore();\r\n                observer.takeRecords();\r\n            }\r\n        });\r\n        var run = function () {\r\n            observer.observe(parent, { childList: true });\r\n        };\r\n        var stop = function () {\r\n            observer.disconnect();\r\n        };\r\n        run();\r\n        return { run: run, stop: stop };\r\n    }\r\n    function iterateShadowNodes(root, iterator) {\r\n        var walker = document.createTreeWalker(root, NodeFilter.SHOW_ELEMENT, {\r\n            acceptNode: function (node) {\r\n                return node.shadowRoot == null ? NodeFilter.FILTER_SKIP : NodeFilter.FILTER_ACCEPT;\r\n            }\r\n        }, false);\r\n        for (var node = (root.shadowRoot ? walker.currentNode : walker.nextNode()); node != null; node = walker.nextNode()) {\r\n            iterator(node);\r\n            iterateShadowNodes(node.shadowRoot, iterator);\r\n        }\r\n    }\n\n    function hslToRGB(_a) {\r\n        var h = _a.h, s = _a.s, l = _a.l, _b = _a.a, a = _b === void 0 ? 1 : _b;\r\n        if (s === 0) {\r\n            var _c = [l, l, l].map(function (x) { return Math.round(x * 255); }), r_1 = _c[0], b_1 = _c[1], g_1 = _c[2];\r\n            return { r: r_1, g: g_1, b: b_1, a: a };\r\n        }\r\n        var c = (1 - Math.abs(2 * l - 1)) * s;\r\n        var x = c * (1 - Math.abs((h / 60) % 2 - 1));\r\n        var m = l - c / 2;\r\n        var _d = (h < 60 ? [c, x, 0] :\r\n            h < 120 ? [x, c, 0] :\r\n                h < 180 ? [0, c, x] :\r\n                    h < 240 ? [0, x, c] :\r\n                        h < 300 ? [x, 0, c] :\r\n                            [c, 0, x]).map(function (n) { return Math.round((n + m) * 255); }), r = _d[0], g = _d[1], b = _d[2];\r\n        return { r: r, g: g, b: b, a: a };\r\n    }\r\n    function rgbToHSL(_a) {\r\n        var r255 = _a.r, g255 = _a.g, b255 = _a.b, _b = _a.a, a = _b === void 0 ? 1 : _b;\r\n        var r = r255 / 255;\r\n        var g = g255 / 255;\r\n        var b = b255 / 255;\r\n        var max = Math.max(r, g, b);\r\n        var min = Math.min(r, g, b);\r\n        var c = max - min;\r\n        var l = (max + min) / 2;\r\n        if (c === 0) {\r\n            return { h: 0, s: 0, l: l, a: a };\r\n        }\r\n        var h = (max === r ? (((g - b) / c) % 6) :\r\n            max === g ? ((b - r) / c + 2) :\r\n                ((r - g) / c + 4)) * 60;\r\n        if (h < 0) {\r\n            h += 360;\r\n        }\r\n        var s = c / (1 - Math.abs(2 * l - 1));\r\n        return { h: h, s: s, l: l, a: a };\r\n    }\r\n    function toFixed(n, digits) {\r\n        if (digits === void 0) { digits = 0; }\r\n        var fixed = n.toFixed(digits);\r\n        if (digits === 0) {\r\n            return fixed;\r\n        }\r\n        var dot = fixed.indexOf('.');\r\n        if (dot >= 0) {\r\n            var zerosMatch = fixed.match(/0+$/);\r\n            if (zerosMatch) {\r\n                if (zerosMatch.index === dot + 1) {\r\n                    return fixed.substring(0, dot);\r\n                }\r\n                return fixed.substring(0, zerosMatch.index);\r\n            }\r\n        }\r\n        return fixed;\r\n    }\r\n    function rgbToString(rgb) {\r\n        var r = rgb.r, g = rgb.g, b = rgb.b, a = rgb.a;\r\n        if (a != null && a < 1) {\r\n            return \"rgba(\" + toFixed(r) + \", \" + toFixed(g) + \", \" + toFixed(b) + \", \" + toFixed(a, 2) + \")\";\r\n        }\r\n        return \"rgb(\" + toFixed(r) + \", \" + toFixed(g) + \", \" + toFixed(b) + \")\";\r\n    }\r\n    function rgbToHexString(_a) {\r\n        var r = _a.r, g = _a.g, b = _a.b, a = _a.a;\r\n        return \"#\" + (a != null && a < 1 ? [r, g, b, Math.round(a * 255)] : [r, g, b]).map(function (x) {\r\n            return \"\" + (x < 16 ? '0' : '') + x.toString(16);\r\n        }).join('');\r\n    }\r\n    var rgbMatch = /^rgba?\\([^\\(\\)]+\\)$/;\r\n    var hslMatch = /^hsla?\\([^\\(\\)]+\\)$/;\r\n    var hexMatch = /^#[0-9a-f]+$/i;\r\n    function parse($color) {\r\n        var c = $color.trim().toLowerCase();\r\n        if (c.match(rgbMatch)) {\r\n            return parseRGB(c);\r\n        }\r\n        if (c.match(hslMatch)) {\r\n            return parseHSL(c);\r\n        }\r\n        if (c.match(hexMatch)) {\r\n            return parseHex(c);\r\n        }\r\n        if (knownColors.has(c)) {\r\n            return getColorByName(c);\r\n        }\r\n        if (systemColors.has(c)) {\r\n            return getSystemColor(c);\r\n        }\r\n        if ($color === 'transparent') {\r\n            return { r: 0, g: 0, b: 0, a: 0 };\r\n        }\r\n        throw new Error(\"Unable to parse \" + $color);\r\n    }\r\n    function getNumbersFromString(str, splitter, range, units) {\r\n        var raw = str.split(splitter).filter(function (x) { return x; });\r\n        var unitsList = Object.entries(units);\r\n        var numbers = raw.map(function (r) { return r.trim(); }).map(function (r, i) {\r\n            var n;\r\n            var unit = unitsList.find(function (_a) {\r\n                var u = _a[0];\r\n                return r.endsWith(u);\r\n            });\r\n            if (unit) {\r\n                n = parseFloat(r.substring(0, r.length - unit[0].length)) / unit[1] * range[i];\r\n            }\r\n            else {\r\n                n = parseFloat(r);\r\n            }\r\n            if (range[i] > 1) {\r\n                return Math.round(n);\r\n            }\r\n            return n;\r\n        });\r\n        return numbers;\r\n    }\r\n    var rgbSplitter = /rgba?|\\(|\\)|\\/|,|\\s/ig;\r\n    var rgbRange = [255, 255, 255, 1];\r\n    var rgbUnits = { '%': 100 };\r\n    function parseRGB($rgb) {\r\n        var _a = getNumbersFromString($rgb, rgbSplitter, rgbRange, rgbUnits), r = _a[0], g = _a[1], b = _a[2], _b = _a[3], a = _b === void 0 ? 1 : _b;\r\n        return { r: r, g: g, b: b, a: a };\r\n    }\r\n    var hslSplitter = /hsla?|\\(|\\)|\\/|,|\\s/ig;\r\n    var hslRange = [360, 1, 1, 1];\r\n    var hslUnits = { '%': 100, 'deg': 360, 'rad': 2 * Math.PI, 'turn': 1 };\r\n    function parseHSL($hsl) {\r\n        var _a = getNumbersFromString($hsl, hslSplitter, hslRange, hslUnits), h = _a[0], s = _a[1], l = _a[2], _b = _a[3], a = _b === void 0 ? 1 : _b;\r\n        return hslToRGB({ h: h, s: s, l: l, a: a });\r\n    }\r\n    function parseHex($hex) {\r\n        var h = $hex.substring(1);\r\n        switch (h.length) {\r\n            case 3:\r\n            case 4: {\r\n                var _a = [0, 1, 2].map(function (i) { return parseInt(\"\" + h[i] + h[i], 16); }), r = _a[0], g = _a[1], b = _a[2];\r\n                var a = h.length === 3 ? 1 : (parseInt(\"\" + h[3] + h[3], 16) / 255);\r\n                return { r: r, g: g, b: b, a: a };\r\n            }\r\n            case 6:\r\n            case 8: {\r\n                var _b = [0, 2, 4].map(function (i) { return parseInt(h.substring(i, i + 2), 16); }), r = _b[0], g = _b[1], b = _b[2];\r\n                var a = h.length === 6 ? 1 : (parseInt(h.substring(6, 8), 16) / 255);\r\n                return { r: r, g: g, b: b, a: a };\r\n            }\r\n        }\r\n        throw new Error(\"Unable to parse \" + $hex);\r\n    }\r\n    function getColorByName($color) {\r\n        var n = knownColors.get($color);\r\n        return {\r\n            r: (n >> 16) & 255,\r\n            g: (n >> 8) & 255,\r\n            b: (n >> 0) & 255,\r\n            a: 1\r\n        };\r\n    }\r\n    function getSystemColor($color) {\r\n        var n = systemColors.get($color);\r\n        return {\r\n            r: (n >> 16) & 255,\r\n            g: (n >> 8) & 255,\r\n            b: (n >> 0) & 255,\r\n            a: 1\r\n        };\r\n    }\r\n    var knownColors = new Map(Object.entries({\r\n        aliceblue: 0xf0f8ff,\r\n        antiquewhite: 0xfaebd7,\r\n        aqua: 0x00ffff,\r\n        aquamarine: 0x7fffd4,\r\n        azure: 0xf0ffff,\r\n        beige: 0xf5f5dc,\r\n        bisque: 0xffe4c4,\r\n        black: 0x000000,\r\n        blanchedalmond: 0xffebcd,\r\n        blue: 0x0000ff,\r\n        blueviolet: 0x8a2be2,\r\n        brown: 0xa52a2a,\r\n        burlywood: 0xdeb887,\r\n        cadetblue: 0x5f9ea0,\r\n        chartreuse: 0x7fff00,\r\n        chocolate: 0xd2691e,\r\n        coral: 0xff7f50,\r\n        cornflowerblue: 0x6495ed,\r\n        cornsilk: 0xfff8dc,\r\n        crimson: 0xdc143c,\r\n        cyan: 0x00ffff,\r\n        darkblue: 0x00008b,\r\n        darkcyan: 0x008b8b,\r\n        darkgoldenrod: 0xb8860b,\r\n        darkgray: 0xa9a9a9,\r\n        darkgrey: 0xa9a9a9,\r\n        darkgreen: 0x006400,\r\n        darkkhaki: 0xbdb76b,\r\n        darkmagenta: 0x8b008b,\r\n        darkolivegreen: 0x556b2f,\r\n        darkorange: 0xff8c00,\r\n        darkorchid: 0x9932cc,\r\n        darkred: 0x8b0000,\r\n        darksalmon: 0xe9967a,\r\n        darkseagreen: 0x8fbc8f,\r\n        darkslateblue: 0x483d8b,\r\n        darkslategray: 0x2f4f4f,\r\n        darkslategrey: 0x2f4f4f,\r\n        darkturquoise: 0x00ced1,\r\n        darkviolet: 0x9400d3,\r\n        deeppink: 0xff1493,\r\n        deepskyblue: 0x00bfff,\r\n        dimgray: 0x696969,\r\n        dimgrey: 0x696969,\r\n        dodgerblue: 0x1e90ff,\r\n        firebrick: 0xb22222,\r\n        floralwhite: 0xfffaf0,\r\n        forestgreen: 0x228b22,\r\n        fuchsia: 0xff00ff,\r\n        gainsboro: 0xdcdcdc,\r\n        ghostwhite: 0xf8f8ff,\r\n        gold: 0xffd700,\r\n        goldenrod: 0xdaa520,\r\n        gray: 0x808080,\r\n        grey: 0x808080,\r\n        green: 0x008000,\r\n        greenyellow: 0xadff2f,\r\n        honeydew: 0xf0fff0,\r\n        hotpink: 0xff69b4,\r\n        indianred: 0xcd5c5c,\r\n        indigo: 0x4b0082,\r\n        ivory: 0xfffff0,\r\n        khaki: 0xf0e68c,\r\n        lavender: 0xe6e6fa,\r\n        lavenderblush: 0xfff0f5,\r\n        lawngreen: 0x7cfc00,\r\n        lemonchiffon: 0xfffacd,\r\n        lightblue: 0xadd8e6,\r\n        lightcoral: 0xf08080,\r\n        lightcyan: 0xe0ffff,\r\n        lightgoldenrodyellow: 0xfafad2,\r\n        lightgray: 0xd3d3d3,\r\n        lightgrey: 0xd3d3d3,\r\n        lightgreen: 0x90ee90,\r\n        lightpink: 0xffb6c1,\r\n        lightsalmon: 0xffa07a,\r\n        lightseagreen: 0x20b2aa,\r\n        lightskyblue: 0x87cefa,\r\n        lightslategray: 0x778899,\r\n        lightslategrey: 0x778899,\r\n        lightsteelblue: 0xb0c4de,\r\n        lightyellow: 0xffffe0,\r\n        lime: 0x00ff00,\r\n        limegreen: 0x32cd32,\r\n        linen: 0xfaf0e6,\r\n        magenta: 0xff00ff,\r\n        maroon: 0x800000,\r\n        mediumaquamarine: 0x66cdaa,\r\n        mediumblue: 0x0000cd,\r\n        mediumorchid: 0xba55d3,\r\n        mediumpurple: 0x9370db,\r\n        mediumseagreen: 0x3cb371,\r\n        mediumslateblue: 0x7b68ee,\r\n        mediumspringgreen: 0x00fa9a,\r\n        mediumturquoise: 0x48d1cc,\r\n        mediumvioletred: 0xc71585,\r\n        midnightblue: 0x191970,\r\n        mintcream: 0xf5fffa,\r\n        mistyrose: 0xffe4e1,\r\n        moccasin: 0xffe4b5,\r\n        navajowhite: 0xffdead,\r\n        navy: 0x000080,\r\n        oldlace: 0xfdf5e6,\r\n        olive: 0x808000,\r\n        olivedrab: 0x6b8e23,\r\n        orange: 0xffa500,\r\n        orangered: 0xff4500,\r\n        orchid: 0xda70d6,\r\n        palegoldenrod: 0xeee8aa,\r\n        palegreen: 0x98fb98,\r\n        paleturquoise: 0xafeeee,\r\n        palevioletred: 0xdb7093,\r\n        papayawhip: 0xffefd5,\r\n        peachpuff: 0xffdab9,\r\n        peru: 0xcd853f,\r\n        pink: 0xffc0cb,\r\n        plum: 0xdda0dd,\r\n        powderblue: 0xb0e0e6,\r\n        purple: 0x800080,\r\n        rebeccapurple: 0x663399,\r\n        red: 0xff0000,\r\n        rosybrown: 0xbc8f8f,\r\n        royalblue: 0x4169e1,\r\n        saddlebrown: 0x8b4513,\r\n        salmon: 0xfa8072,\r\n        sandybrown: 0xf4a460,\r\n        seagreen: 0x2e8b57,\r\n        seashell: 0xfff5ee,\r\n        sienna: 0xa0522d,\r\n        silver: 0xc0c0c0,\r\n        skyblue: 0x87ceeb,\r\n        slateblue: 0x6a5acd,\r\n        slategray: 0x708090,\r\n        slategrey: 0x708090,\r\n        snow: 0xfffafa,\r\n        springgreen: 0x00ff7f,\r\n        steelblue: 0x4682b4,\r\n        tan: 0xd2b48c,\r\n        teal: 0x008080,\r\n        thistle: 0xd8bfd8,\r\n        tomato: 0xff6347,\r\n        turquoise: 0x40e0d0,\r\n        violet: 0xee82ee,\r\n        wheat: 0xf5deb3,\r\n        white: 0xffffff,\r\n        whitesmoke: 0xf5f5f5,\r\n        yellow: 0xffff00,\r\n        yellowgreen: 0x9acd32,\r\n    }));\r\n    var systemColors = new Map(Object.entries({\r\n        ActiveBorder: 0x3b99fc,\r\n        ActiveCaption: 0x000000,\r\n        AppWorkspace: 0xaaaaaa,\r\n        Background: 0x6363ce,\r\n        ButtonFace: 0xffffff,\r\n        ButtonHighlight: 0xe9e9e9,\r\n        ButtonShadow: 0x9fa09f,\r\n        ButtonText: 0x000000,\r\n        CaptionText: 0x000000,\r\n        GrayText: 0x7f7f7f,\r\n        Highlight: 0xb2d7ff,\r\n        HighlightText: 0x000000,\r\n        InactiveBorder: 0xffffff,\r\n        InactiveCaption: 0xffffff,\r\n        InactiveCaptionText: 0x000000,\r\n        InfoBackground: 0xfbfcc5,\r\n        InfoText: 0x000000,\r\n        Menu: 0xf6f6f6,\r\n        MenuText: 0xffffff,\r\n        Scrollbar: 0xaaaaaa,\r\n        ThreeDDarkShadow: 0x000000,\r\n        ThreeDFace: 0xc0c0c0,\r\n        ThreeDHighlight: 0xffffff,\r\n        ThreeDLightShadow: 0xffffff,\r\n        ThreeDShadow: 0x000000,\r\n        Window: 0xececec,\r\n        WindowFrame: 0xaaaaaa,\r\n        WindowText: 0x000000,\r\n        '-webkit-focus-ring-color': 0xe59700\r\n    }).map(function (_a) {\r\n        var key = _a[0], value = _a[1];\r\n        return [key.toLowerCase(), value];\r\n    }));\n\n    function scale(x, inLow, inHigh, outLow, outHigh) {\r\n        return (x - inLow) * (outHigh - outLow) / (inHigh - inLow) + outLow;\r\n    }\r\n    function clamp(x, min, max) {\r\n        return Math.min(max, Math.max(min, x));\r\n    }\r\n    function multiplyMatrices(m1, m2) {\r\n        var result = [];\r\n        for (var i = 0; i < m1.length; i++) {\r\n            result[i] = [];\r\n            for (var j = 0; j < m2[0].length; j++) {\r\n                var sum = 0;\r\n                for (var k = 0; k < m1[0].length; k++) {\r\n                    sum += m1[i][k] * m2[k][j];\r\n                }\r\n                result[i][j] = sum;\r\n            }\r\n        }\r\n        return result;\r\n    }\n\n    function getMatches(regex, input, group) {\r\n        if (group === void 0) { group = 0; }\r\n        var matches = [];\r\n        var m;\r\n        while (m = regex.exec(input)) {\r\n            matches.push(m[group]);\r\n        }\r\n        return matches;\r\n    }\n\n    function createFilterMatrix(config) {\r\n        var m = Matrix.identity();\r\n        if (config.sepia !== 0) {\r\n            m = multiplyMatrices(m, Matrix.sepia(config.sepia / 100));\r\n        }\r\n        if (config.grayscale !== 0) {\r\n            m = multiplyMatrices(m, Matrix.grayscale(config.grayscale / 100));\r\n        }\r\n        if (config.contrast !== 100) {\r\n            m = multiplyMatrices(m, Matrix.contrast(config.contrast / 100));\r\n        }\r\n        if (config.brightness !== 100) {\r\n            m = multiplyMatrices(m, Matrix.brightness(config.brightness / 100));\r\n        }\r\n        if (config.mode === 1) {\r\n            m = multiplyMatrices(m, Matrix.invertNHue());\r\n        }\r\n        return m;\r\n    }\r\n    function applyColorMatrix(_a, matrix) {\r\n        var r = _a[0], g = _a[1], b = _a[2];\r\n        var rgb = [[r / 255], [g / 255], [b / 255], [1], [1]];\r\n        var result = multiplyMatrices(matrix, rgb);\r\n        return [0, 1, 2].map(function (i) { return clamp(Math.round(result[i][0] * 255), 0, 255); });\r\n    }\r\n    var Matrix = {\r\n        identity: function () {\r\n            return [\r\n                [1, 0, 0, 0, 0],\r\n                [0, 1, 0, 0, 0],\r\n                [0, 0, 1, 0, 0],\r\n                [0, 0, 0, 1, 0],\r\n                [0, 0, 0, 0, 1]\r\n            ];\r\n        },\r\n        invertNHue: function () {\r\n            return [\r\n                [0.333, -0.667, -0.667, 0, 1],\r\n                [-0.667, 0.333, -0.667, 0, 1],\r\n                [-0.667, -0.667, 0.333, 0, 1],\r\n                [0, 0, 0, 1, 0],\r\n                [0, 0, 0, 0, 1]\r\n            ];\r\n        },\r\n        brightness: function (v) {\r\n            return [\r\n                [v, 0, 0, 0, 0],\r\n                [0, v, 0, 0, 0],\r\n                [0, 0, v, 0, 0],\r\n                [0, 0, 0, 1, 0],\r\n                [0, 0, 0, 0, 1]\r\n            ];\r\n        },\r\n        contrast: function (v) {\r\n            var t = (1 - v) / 2;\r\n            return [\r\n                [v, 0, 0, 0, t],\r\n                [0, v, 0, 0, t],\r\n                [0, 0, v, 0, t],\r\n                [0, 0, 0, 1, 0],\r\n                [0, 0, 0, 0, 1]\r\n            ];\r\n        },\r\n        sepia: function (v) {\r\n            return [\r\n                [(0.393 + 0.607 * (1 - v)), (0.769 - 0.769 * (1 - v)), (0.189 - 0.189 * (1 - v)), 0, 0],\r\n                [(0.349 - 0.349 * (1 - v)), (0.686 + 0.314 * (1 - v)), (0.168 - 0.168 * (1 - v)), 0, 0],\r\n                [(0.272 - 0.272 * (1 - v)), (0.534 - 0.534 * (1 - v)), (0.131 + 0.869 * (1 - v)), 0, 0],\r\n                [0, 0, 0, 1, 0],\r\n                [0, 0, 0, 0, 1]\r\n            ];\r\n        },\r\n        grayscale: function (v) {\r\n            return [\r\n                [(0.2126 + 0.7874 * (1 - v)), (0.7152 - 0.7152 * (1 - v)), (0.0722 - 0.0722 * (1 - v)), 0, 0],\r\n                [(0.2126 - 0.2126 * (1 - v)), (0.7152 + 0.2848 * (1 - v)), (0.0722 - 0.0722 * (1 - v)), 0, 0],\r\n                [(0.2126 - 0.2126 * (1 - v)), (0.7152 - 0.7152 * (1 - v)), (0.0722 + 0.9278 * (1 - v)), 0, 0],\r\n                [0, 0, 0, 1, 0],\r\n                [0, 0, 0, 0, 1]\r\n            ];\r\n        },\r\n    };\n\n    var colorModificationCache = new Map();\r\n    function clearColorModificationCache() {\r\n        colorModificationCache.clear();\r\n    }\r\n    function modifyColorWithCache(rgb, filter, modifyHSL) {\r\n        var fnCache;\r\n        if (colorModificationCache.has(modifyHSL)) {\r\n            fnCache = colorModificationCache.get(modifyHSL);\r\n        }\r\n        else {\r\n            fnCache = new Map();\r\n            colorModificationCache.set(modifyHSL, fnCache);\r\n        }\r\n        var id = Object.entries(rgb)\r\n            .concat(Object.entries(filter).filter(function (_a) {\r\n            var key = _a[0];\r\n            return ['mode', 'brightness', 'contrast', 'grayscale', 'sepia'].indexOf(key) >= 0;\r\n        }))\r\n            .map(function (_a) {\r\n            var key = _a[0], value = _a[1];\r\n            return key + \":\" + value;\r\n        })\r\n            .join(';');\r\n        if (fnCache.has(id)) {\r\n            return fnCache.get(id);\r\n        }\r\n        var hsl = rgbToHSL(rgb);\r\n        var modified = modifyHSL(hsl);\r\n        var _a = hslToRGB(modified), r = _a.r, g = _a.g, b = _a.b, a = _a.a;\r\n        var matrix = createFilterMatrix(filter);\r\n        var _b = applyColorMatrix([r, g, b], matrix), rf = _b[0], gf = _b[1], bf = _b[2];\r\n        var color = (a === 1 ?\r\n            rgbToHexString({ r: rf, g: gf, b: bf }) :\r\n            rgbToString({ r: rf, g: gf, b: bf, a: a }));\r\n        fnCache.set(id, color);\r\n        return color;\r\n    }\r\n    function noopHSL(hsl) {\r\n        return hsl;\r\n    }\r\n    function modifyColor(rgb, theme) {\r\n        return modifyColorWithCache(rgb, theme, noopHSL);\r\n    }\r\n    function modifyLightModeHSL(_a) {\r\n        var h = _a.h, s = _a.s, l = _a.l, a = _a.a;\r\n        var lMin = 0;\r\n        var lMid = 0.4;\r\n        var lMax = 0.9;\r\n        var sNeutralLim = 0.36;\r\n        var lNeutralDark = 0.2;\r\n        var lNeutralLight = 0.8;\r\n        var sColored = 0.16;\r\n        var hColoredL0 = 205;\r\n        var hColoredL1 = 40;\r\n        var lx = scale(l, 0, 1, lMin, lMax);\r\n        var hx = h;\r\n        var sx = s;\r\n        var isNeutral = l < lNeutralDark || l > lNeutralLight || s < sNeutralLim;\r\n        if (isNeutral) {\r\n            sx = (l < lMid ?\r\n                scale(l, 0, lMid, sColored, 0) :\r\n                scale(l, lMid, 1, 0, sColored));\r\n            hx = (l < lMid ? hColoredL0 : hColoredL1);\r\n        }\r\n        return { h: hx, s: sx, l: lx, a: a };\r\n    }\r\n    function modifyBgHSL(_a) {\r\n        var h = _a.h, s = _a.s, l = _a.l, a = _a.a;\r\n        var lMin = 0.1;\r\n        var lMaxS0 = 0.25;\r\n        var lMaxS1 = 0.4;\r\n        var sNeutralLim = 0.12;\r\n        var lNeutralLight = 0.8;\r\n        var sColored = 0.05;\r\n        var hColored = 205;\r\n        var hBlue0 = 200;\r\n        var hBlue1 = 280;\r\n        var lMax = scale(s, 0, 1, lMaxS0, lMaxS1);\r\n        var lx = (l < lMax ?\r\n            l :\r\n            l < 0.5 ?\r\n                lMax :\r\n                scale(l, 0.5, 1, lMax, lMin));\r\n        var isNeutral = (l >= lNeutralLight && h > hBlue0 && h < hBlue1) || s < sNeutralLim;\r\n        var hx = h;\r\n        var sx = s;\r\n        if (isNeutral) {\r\n            sx = sColored;\r\n            hx = hColored;\r\n        }\r\n        return { h: hx, s: sx, l: lx, a: a };\r\n    }\r\n    function modifyBackgroundColor(rgb, filter) {\r\n        if (filter.mode === 0) {\r\n            return modifyColorWithCache(rgb, filter, modifyLightModeHSL);\r\n        }\r\n        return modifyColorWithCache(rgb, __assign(__assign({}, filter), { mode: 0 }), modifyBgHSL);\r\n    }\r\n    function modifyFgHSL(_a) {\r\n        var h = _a.h, s = _a.s, l = _a.l, a = _a.a;\r\n        var lMax = 0.9;\r\n        var lMinS0 = 0.7;\r\n        var lMinS1 = 0.6;\r\n        var sNeutralLim = 0.24;\r\n        var lNeutralDark = 0.2;\r\n        var sColored = 0.10;\r\n        var hColored = 40;\r\n        var hBlue0 = 205;\r\n        var hBlue1 = 245;\r\n        var hBlueMax = 220;\r\n        var lBlueMin = 0.7;\r\n        var isBlue = h > hBlue0 && h <= hBlue1;\r\n        var lMin = scale(s, 0, 1, isBlue ? scale(h, hBlue0, hBlue1, lMinS0, lBlueMin) : lMinS0, lMinS1);\r\n        var lx = (l < 0.5 ?\r\n            scale(l, 0, 0.5, lMax, lMin) :\r\n            l < lMin ?\r\n                lMin :\r\n                l);\r\n        var hx = h;\r\n        var sx = s;\r\n        if (isBlue) {\r\n            hx = scale(hx, hBlue0, hBlue1, hBlue0, hBlueMax);\r\n        }\r\n        var isNeutral = l < lNeutralDark || s < sNeutralLim;\r\n        if (isNeutral) {\r\n            sx = sColored;\r\n            hx = hColored;\r\n        }\r\n        return { h: hx, s: sx, l: lx, a: a };\r\n    }\r\n    function modifyForegroundColor(rgb, filter) {\r\n        if (filter.mode === 0) {\r\n            return modifyColorWithCache(rgb, filter, modifyLightModeHSL);\r\n        }\r\n        return modifyColorWithCache(rgb, __assign(__assign({}, filter), { mode: 0 }), modifyFgHSL);\r\n    }\r\n    function modifyBorderHSL(_a) {\r\n        var h = _a.h, s = _a.s, l = _a.l, a = _a.a;\r\n        var lMinS0 = 0.2;\r\n        var lMinS1 = 0.3;\r\n        var lMaxS0 = 0.4;\r\n        var lMaxS1 = 0.5;\r\n        var lMin = scale(s, 0, 1, lMinS0, lMinS1);\r\n        var lMax = scale(s, 0, 1, lMaxS0, lMaxS1);\r\n        var lx = scale(l, 0, 1, lMax, lMin);\r\n        return { h: h, s: s, l: lx, a: a };\r\n    }\r\n    function modifyBorderColor(rgb, filter) {\r\n        if (filter.mode === 0) {\r\n            return modifyColorWithCache(rgb, filter, modifyLightModeHSL);\r\n        }\r\n        return modifyColorWithCache(rgb, __assign(__assign({}, filter), { mode: 0 }), modifyBorderHSL);\r\n    }\r\n    function modifyShadowColor(rgb, filter) {\r\n        return modifyBackgroundColor(rgb, filter);\r\n    }\r\n    function modifyGradientColor(rgb, filter) {\r\n        return modifyBackgroundColor(rgb, filter);\r\n    }\n\n    function getURLHost(url) {\r\n        return url.match(/^(.*?\\/{2,3})?(.+?)(\\/|$)/)[2];\r\n    }\n\n    function createTextStyle(config) {\r\n        var lines = [];\r\n        lines.push('* {');\r\n        if (config.useFont && config.fontFamily) {\r\n            lines.push(\"  font-family: \" + config.fontFamily + \" !important;\");\r\n        }\r\n        if (config.textStroke > 0) {\r\n            lines.push(\"  -webkit-text-stroke: \" + config.textStroke + \"px !important;\");\r\n            lines.push(\"  text-stroke: \" + config.textStroke + \"px !important;\");\r\n        }\r\n        lines.push('}');\r\n        return lines.join('\\n');\r\n    }\n\n    var FilterMode;\r\n    (function (FilterMode) {\r\n        FilterMode[FilterMode[\"light\"] = 0] = \"light\";\r\n        FilterMode[FilterMode[\"dark\"] = 1] = \"dark\";\r\n    })(FilterMode || (FilterMode = {}));\r\n    function getCSSFilterValue(config) {\r\n        var filters = [];\r\n        if (config.mode === FilterMode.dark) {\r\n            filters.push('invert(100%) hue-rotate(180deg)');\r\n        }\r\n        if (config.brightness !== 100) {\r\n            filters.push(\"brightness(\" + config.brightness + \"%)\");\r\n        }\r\n        if (config.contrast !== 100) {\r\n            filters.push(\"contrast(\" + config.contrast + \"%)\");\r\n        }\r\n        if (config.grayscale !== 0) {\r\n            filters.push(\"grayscale(\" + config.grayscale + \"%)\");\r\n        }\r\n        if (config.sepia !== 0) {\r\n            filters.push(\"sepia(\" + config.sepia + \"%)\");\r\n        }\r\n        if (filters.length === 0) {\r\n            return null;\r\n        }\r\n        return filters.join(' ');\r\n    }\n\n    function toSVGMatrix(matrix) {\r\n        return matrix.slice(0, 4).map(function (m) { return m.map(function (m) { return m.toFixed(3); }).join(' '); }).join(' ');\r\n    }\r\n    function getSVGFilterMatrixValue(config) {\r\n        return toSVGMatrix(createFilterMatrix(config));\r\n    }\n\n    var counter = 0;\r\n    var resolvers = new Map();\r\n    var rejectors = new Map();\r\n    function bgFetch(request) {\r\n        return new Promise(function (resolve, reject) {\r\n            var id = ++counter;\r\n            resolvers.set(id, resolve);\r\n            rejectors.set(id, reject);\r\n            chrome.runtime.sendMessage({ type: 'fetch', data: request, id: id });\r\n        });\r\n    }\r\n    chrome.runtime.onMessage.addListener(function (_a) {\r\n        var type = _a.type, data = _a.data, error = _a.error, id = _a.id;\r\n        if (type === 'fetch-response') {\r\n            var resolve = resolvers.get(id);\r\n            var reject = rejectors.get(id);\r\n            resolvers.delete(id);\r\n            rejectors.delete(id);\r\n            if (error) {\r\n                reject && reject(error);\r\n            }\r\n            else {\r\n                resolve && resolve(data);\r\n            }\r\n        }\r\n    });\n\n    function getImageDetails(url) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var dataURL, image, info;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!url.startsWith('data:')) return [3, 1];\r\n                        dataURL = url;\r\n                        return [3, 3];\r\n                    case 1: return [4, getImageDataURL(url)];\r\n                    case 2:\r\n                        dataURL = _a.sent();\r\n                        _a.label = 3;\r\n                    case 3: return [4, urlToImage(dataURL)];\r\n                    case 4:\r\n                        image = _a.sent();\r\n                        info = analyzeImage(image);\r\n                        return [2, __assign({ src: url, dataURL: dataURL, width: image.naturalWidth, height: image.naturalHeight }, info)];\r\n                }\r\n            });\r\n        });\r\n    }\r\n    function getImageDataURL(url) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!(getURLHost(url) === location.host)) return [3, 2];\r\n                        return [4, loadAsDataURL(url)];\r\n                    case 1: return [2, _a.sent()];\r\n                    case 2: return [4, bgFetch({ url: url, responseType: 'data-url' })];\r\n                    case 3: return [2, _a.sent()];\r\n                }\r\n            });\r\n        });\r\n    }\r\n    function urlToImage(url) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            return __generator(this, function (_a) {\r\n                return [2, new Promise(function (resolve, reject) {\r\n                        var image = new Image();\r\n                        image.onload = function () { return resolve(image); };\r\n                        image.onerror = function () { return reject(\"Unable to load image \" + url); };\r\n                        image.src = url;\r\n                    })];\r\n            });\r\n        });\r\n    }\r\n    function analyzeImage(image) {\r\n        var MAX_ANALIZE_PIXELS_COUNT = 32 * 32;\r\n        var naturalPixelsCount = image.naturalWidth * image.naturalHeight;\r\n        var k = Math.min(1, Math.sqrt(MAX_ANALIZE_PIXELS_COUNT / naturalPixelsCount));\r\n        var width = Math.max(1, Math.round(image.naturalWidth * k));\r\n        var height = Math.max(1, Math.round(image.naturalHeight * k));\r\n        var canvas = document.createElement('canvas');\r\n        canvas.width = width;\r\n        canvas.height = height;\r\n        var context = canvas.getContext('2d');\r\n        context.imageSmoothingEnabled = false;\r\n        context.drawImage(image, 0, 0, width, height);\r\n        var imageData = context.getImageData(0, 0, width, height);\r\n        var d = imageData.data;\r\n        var TRANSPARENT_ALPHA_THRESHOLD = 0.05;\r\n        var DARK_LIGHTNESS_THRESHOLD = 0.4;\r\n        var LIGHT_LIGHTNESS_THRESHOLD = 0.7;\r\n        var transparentPixelsCount = 0;\r\n        var darkPixelsCount = 0;\r\n        var lightPixelsCount = 0;\r\n        var i, x, y;\r\n        var r, g, b, a;\r\n        var l, min, max;\r\n        for (y = 0; y < height; y++) {\r\n            for (x = 0; x < width; x++) {\r\n                i = 4 * (y * width + x);\r\n                r = d[i + 0] / 255;\r\n                g = d[i + 1] / 255;\r\n                b = d[i + 2] / 255;\r\n                a = d[i + 3] / 255;\r\n                if (a < TRANSPARENT_ALPHA_THRESHOLD) {\r\n                    transparentPixelsCount++;\r\n                }\r\n                else {\r\n                    min = Math.min(r, g, b);\r\n                    max = Math.max(r, g, b);\r\n                    l = (max + min) / 2;\r\n                    if (l < DARK_LIGHTNESS_THRESHOLD) {\r\n                        darkPixelsCount++;\r\n                    }\r\n                    if (l > LIGHT_LIGHTNESS_THRESHOLD) {\r\n                        lightPixelsCount++;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        var totalPixelsCount = width * height;\r\n        var opaquePixelsCount = totalPixelsCount - transparentPixelsCount;\r\n        var DARK_IMAGE_THRESHOLD = 0.7;\r\n        var LIGHT_IMAGE_THRESHOLD = 0.7;\r\n        var TRANSPARENT_IMAGE_THRESHOLD = 0.1;\r\n        var LARGE_IMAGE_PIXELS_COUNT = 800 * 600;\r\n        return {\r\n            isDark: ((darkPixelsCount / opaquePixelsCount) >= DARK_IMAGE_THRESHOLD),\r\n            isLight: ((lightPixelsCount / opaquePixelsCount) >= LIGHT_IMAGE_THRESHOLD),\r\n            isTransparent: ((transparentPixelsCount / totalPixelsCount) >= TRANSPARENT_IMAGE_THRESHOLD),\r\n            isLarge: (naturalPixelsCount >= LARGE_IMAGE_PIXELS_COUNT),\r\n        };\r\n    }\r\n    function getFilteredImageDataURL(_a, filter) {\r\n        var dataURL = _a.dataURL, width = _a.width, height = _a.height;\r\n        var matrix = getSVGFilterMatrixValue(filter);\r\n        var svg = [\r\n            \"<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" xmlns:xlink=\\\"http://www.w3.org/1999/xlink\\\" width=\\\"\" + width + \"\\\" height=\\\"\" + height + \"\\\">\",\r\n            '<defs>',\r\n            '<filter id=\"darkreader-image-filter\">',\r\n            \"<feColorMatrix type=\\\"matrix\\\" values=\\\"\" + matrix + \"\\\" />\",\r\n            '</filter>',\r\n            '</defs>',\r\n            \"<image width=\\\"\" + width + \"\\\" height=\\\"\" + height + \"\\\" filter=\\\"url(#darkreader-image-filter)\\\" xlink:href=\\\"\" + dataURL + \"\\\" />\",\r\n            '</svg>',\r\n        ].join('');\r\n        var bytes = new Uint8Array(svg.length);\r\n        for (var i = 0; i < svg.length; i++) {\r\n            bytes[i] = svg.charCodeAt(i);\r\n        }\r\n        var blob = new Blob([bytes], { type: 'image/svg+xml' });\r\n        var objectURL = URL.createObjectURL(blob);\r\n        return objectURL;\r\n    }\n\n    function getModifiableCSSDeclaration(property, value, rule, isCancelled) {\r\n        var important = Boolean(rule && rule.style && rule.style.getPropertyPriority(property));\r\n        var sourceValue = value;\r\n        if (property.startsWith('--')) {\r\n            return null;\r\n        }\r\n        else if ((property.indexOf('color') >= 0 && property !== '-webkit-print-color-adjust') ||\r\n            property === 'fill' ||\r\n            property === 'stroke') {\r\n            var modifier = getColorModifier(property, value);\r\n            if (modifier) {\r\n                return { property: property, value: modifier, important: important, sourceValue: sourceValue };\r\n            }\r\n        }\r\n        else if (property === 'background-image') {\r\n            var modifier = getBgImageModifier(property, value, rule, isCancelled);\r\n            if (modifier) {\r\n                return { property: property, value: modifier, important: important, sourceValue: sourceValue };\r\n            }\r\n        }\r\n        else if (property.indexOf('shadow') >= 0) {\r\n            var modifier = getShadowModifier(property, value);\r\n            if (modifier) {\r\n                return { property: property, value: modifier, important: important, sourceValue: sourceValue };\r\n            }\r\n        }\r\n        return null;\r\n    }\r\n    function getModifiedUserAgentStyle(filter, isIFrame) {\r\n        var lines = [];\r\n        if (!isIFrame) {\r\n            lines.push('html {');\r\n            lines.push(\"    background-color: \" + modifyBackgroundColor({ r: 255, g: 255, b: 255 }, filter) + \" !important;\");\r\n            lines.push('}');\r\n        }\r\n        lines.push((isIFrame ? '' : 'html, body, ') + \"input, textarea, select, button {\");\r\n        lines.push(\"    background-color: \" + modifyBackgroundColor({ r: 255, g: 255, b: 255 }, filter) + \";\");\r\n        lines.push('}');\r\n        lines.push('html, body, input, textarea, select, button {');\r\n        lines.push(\"    border-color: \" + modifyBorderColor({ r: 76, g: 76, b: 76 }, filter) + \";\");\r\n        lines.push(\"    color: \" + modifyForegroundColor({ r: 0, g: 0, b: 0 }, filter) + \";\");\r\n        lines.push('}');\r\n        lines.push('a {');\r\n        lines.push(\"    color: \" + modifyForegroundColor({ r: 0, g: 64, b: 255 }, filter) + \";\");\r\n        lines.push('}');\r\n        lines.push('table {');\r\n        lines.push(\"    border-color: \" + modifyBorderColor({ r: 128, g: 128, b: 128 }, filter) + \";\");\r\n        lines.push('}');\r\n        lines.push('::placeholder {');\r\n        lines.push(\"    color: \" + modifyForegroundColor({ r: 169, g: 169, b: 169 }, filter) + \";\");\r\n        lines.push('}');\r\n        ['::selection', '::-moz-selection'].forEach(function (selection) {\r\n            lines.push(selection + \" {\");\r\n            lines.push(\"    background-color: \" + modifyBackgroundColor({ r: 0, g: 96, b: 212 }, filter) + \";\");\r\n            lines.push(\"    color: \" + modifyForegroundColor({ r: 255, g: 255, b: 255 }, filter) + \";\");\r\n            lines.push('}');\r\n        });\r\n        lines.push('input:-webkit-autofill,');\r\n        lines.push('textarea:-webkit-autofill,');\r\n        lines.push('select:-webkit-autofill {');\r\n        lines.push(\"    background-color: \" + modifyBackgroundColor({ r: 250, g: 255, b: 189 }, filter) + \" !important;\");\r\n        lines.push(\"    color: \" + modifyForegroundColor({ r: 0, g: 0, b: 0 }, filter) + \" !important;\");\r\n        lines.push('}');\r\n        if (!isMacOS()) {\r\n            lines.push('::-webkit-scrollbar {');\r\n            lines.push(\"    background-color: \" + modifyBackgroundColor({ r: 241, g: 241, b: 241 }, filter) + \";\");\r\n            lines.push(\"    color: \" + modifyForegroundColor({ r: 96, g: 96, b: 96 }, filter) + \";\");\r\n            lines.push('}');\r\n            lines.push('::-webkit-scrollbar-thumb {');\r\n            lines.push(\"    background-color: \" + modifyBackgroundColor({ r: 193, g: 193, b: 193 }, filter) + \";\");\r\n            lines.push('}');\r\n            lines.push('::-webkit-scrollbar-thumb:hover {');\r\n            lines.push(\"    background-color: \" + modifyBackgroundColor({ r: 166, g: 166, b: 166 }, filter) + \";\");\r\n            lines.push('}');\r\n            lines.push('::-webkit-scrollbar-thumb:active {');\r\n            lines.push(\"    background-color: \" + modifyBackgroundColor({ r: 96, g: 96, b: 96 }, filter) + \";\");\r\n            lines.push('}');\r\n            lines.push('::-webkit-scrollbar-corner {');\r\n            lines.push(\"    background-color: \" + modifyBackgroundColor({ r: 255, g: 255, b: 255 }, filter) + \";\");\r\n            lines.push('}');\r\n            lines.push('* {');\r\n            lines.push(\"    scrollbar-color: \" + modifyBackgroundColor({ r: 193, g: 193, b: 193 }, filter) + \" \" + modifyBackgroundColor({ r: 241, g: 241, b: 241 }, filter) + \";\");\r\n            lines.push('}');\r\n        }\r\n        return lines.join('\\n');\r\n    }\r\n    function getModifiedFallbackStyle(filter, _a) {\r\n        var strict = _a.strict;\r\n        var lines = [];\r\n        lines.push(\"html, body, \" + (strict ? 'body *' : 'body > *') + \" {\");\r\n        lines.push(\"    background-color: \" + modifyBackgroundColor({ r: 255, g: 255, b: 255 }, filter) + \" !important;\");\r\n        lines.push(\"    border-color: \" + modifyBorderColor({ r: 64, g: 64, b: 64 }, filter) + \" !important;\");\r\n        lines.push(\"    color: \" + modifyForegroundColor({ r: 0, g: 0, b: 0 }, filter) + \" !important;\");\r\n        lines.push('}');\r\n        return lines.join('\\n');\r\n    }\r\n    var unparsableColors = new Set([\r\n        'inherit',\r\n        'transparent',\r\n        'initial',\r\n        'currentcolor',\r\n        'none',\r\n    ]);\r\n    var colorParseCache = new Map();\r\n    function parseColorWithCache($color) {\r\n        $color = $color.trim();\r\n        if (colorParseCache.has($color)) {\r\n            return colorParseCache.get($color);\r\n        }\r\n        var color = parse($color);\r\n        colorParseCache.set($color, color);\r\n        return color;\r\n    }\r\n    function tryParseColor($color) {\r\n        try {\r\n            return parseColorWithCache($color);\r\n        }\r\n        catch (err) {\r\n            return null;\r\n        }\r\n    }\r\n    function getColorModifier(prop, value) {\r\n        if (unparsableColors.has(value.toLowerCase())) {\r\n            return value;\r\n        }\r\n        try {\r\n            var rgb_1 = parseColorWithCache(value);\r\n            if (prop.indexOf('background') >= 0) {\r\n                return function (filter) { return modifyBackgroundColor(rgb_1, filter); };\r\n            }\r\n            if (prop.indexOf('border') >= 0 || prop.indexOf('outline') >= 0) {\r\n                return function (filter) { return modifyBorderColor(rgb_1, filter); };\r\n            }\r\n            return function (filter) { return modifyForegroundColor(rgb_1, filter); };\r\n        }\r\n        catch (err) {\r\n            logWarn('Color parse error', err);\r\n            return null;\r\n        }\r\n    }\r\n    var gradientRegex = /[\\-a-z]+gradient\\(([^\\(\\)]*(\\(([^\\(\\)]*(\\(.*?\\)))*[^\\(\\)]*\\))){0,15}[^\\(\\)]*\\)/g;\r\n    var imageDetailsCache = new Map();\r\n    var awaitingForImageLoading = new Map();\r\n    function getBgImageModifier(prop, value, rule, isCancelled) {\r\n        var _this = this;\r\n        try {\r\n            var gradients = getMatches(gradientRegex, value);\r\n            var urls = getMatches(cssURLRegex, value);\r\n            if (urls.length === 0 && gradients.length === 0) {\r\n                return value;\r\n            }\r\n            var getIndices = function (matches) {\r\n                var index = 0;\r\n                return matches.map(function (match) {\r\n                    var valueIndex = value.indexOf(match, index);\r\n                    index = valueIndex + match.length;\r\n                    return { match: match, index: valueIndex };\r\n                });\r\n            };\r\n            var matches_1 = getIndices(urls).map(function (i) { return (__assign({ type: 'url' }, i)); })\r\n                .concat(getIndices(gradients).map(function (i) { return (__assign({ type: 'gradient' }, i)); }))\r\n                .sort(function (a, b) { return a.index - b.index; });\r\n            var getGradientModifier_1 = function (gradient) {\r\n                var match = gradient.match(/^(.*-gradient)\\((.*)\\)$/);\r\n                var type = match[1];\r\n                var content = match[2];\r\n                var partsRegex = /([^\\(\\),]+(\\([^\\(\\)]*(\\([^\\(\\)]*\\)*[^\\(\\)]*)?\\))?[^\\(\\),]*),?/g;\r\n                var colorStopRegex = /^(from|color-stop|to)\\(([^\\(\\)]*?,\\s*)?(.*?)\\)$/;\r\n                var parts = getMatches(partsRegex, content, 1).map(function (part) {\r\n                    part = part.trim();\r\n                    var rgb = tryParseColor(part);\r\n                    if (rgb) {\r\n                        return function (filter) { return modifyGradientColor(rgb, filter); };\r\n                    }\r\n                    var space = part.lastIndexOf(' ');\r\n                    rgb = tryParseColor(part.substring(0, space));\r\n                    if (rgb) {\r\n                        return function (filter) { return modifyGradientColor(rgb, filter) + \" \" + part.substring(space + 1); };\r\n                    }\r\n                    var colorStopMatch = part.match(colorStopRegex);\r\n                    if (colorStopMatch) {\r\n                        rgb = tryParseColor(colorStopMatch[3]);\r\n                        if (rgb) {\r\n                            return function (filter) { return colorStopMatch[1] + \"(\" + (colorStopMatch[2] ? colorStopMatch[2] + \", \" : '') + modifyGradientColor(rgb, filter) + \")\"; };\r\n                        }\r\n                    }\r\n                    return function () { return part; };\r\n                });\r\n                return function (filter) {\r\n                    return type + \"(\" + parts.map(function (modify) { return modify(filter); }).join(', ') + \")\";\r\n                };\r\n            };\r\n            var getURLModifier_1 = function (urlValue) {\r\n                var url = getCSSURLValue(urlValue);\r\n                if (rule.parentStyleSheet.href) {\r\n                    var basePath = getCSSBaseBath(rule.parentStyleSheet.href);\r\n                    url = getAbsoluteURL(basePath, url);\r\n                }\r\n                else if (rule.parentStyleSheet.ownerNode && rule.parentStyleSheet.ownerNode.baseURI) {\r\n                    url = getAbsoluteURL(rule.parentStyleSheet.ownerNode.baseURI, url);\r\n                }\r\n                else {\r\n                    url = getAbsoluteURL(location.origin, url);\r\n                }\r\n                var absoluteValue = \"url(\\\"\" + url + \"\\\")\";\r\n                return function (filter) { return __awaiter(_this, void 0, void 0, function () {\r\n                    var imageDetails, awaiters_1, err_1, bgImageValue;\r\n                    return __generator(this, function (_a) {\r\n                        switch (_a.label) {\r\n                            case 0:\r\n                                if (!imageDetailsCache.has(url)) return [3, 1];\r\n                                imageDetails = imageDetailsCache.get(url);\r\n                                return [3, 7];\r\n                            case 1:\r\n                                _a.trys.push([1, 6, , 7]);\r\n                                if (!awaitingForImageLoading.has(url)) return [3, 3];\r\n                                awaiters_1 = awaitingForImageLoading.get(url);\r\n                                return [4, new Promise(function (resolve) { return awaiters_1.push(resolve); })];\r\n                            case 2:\r\n                                imageDetails = _a.sent();\r\n                                if (!imageDetails) {\r\n                                    return [2, null];\r\n                                }\r\n                                return [3, 5];\r\n                            case 3:\r\n                                awaitingForImageLoading.set(url, []);\r\n                                return [4, getImageDetails(url)];\r\n                            case 4:\r\n                                imageDetails = _a.sent();\r\n                                imageDetailsCache.set(url, imageDetails);\r\n                                awaitingForImageLoading.get(url).forEach(function (resolve) { return resolve(imageDetails); });\r\n                                awaitingForImageLoading.delete(url);\r\n                                _a.label = 5;\r\n                            case 5:\r\n                                if (isCancelled()) {\r\n                                    return [2, null];\r\n                                }\r\n                                return [3, 7];\r\n                            case 6:\r\n                                err_1 = _a.sent();\r\n                                logWarn(err_1);\r\n                                if (awaitingForImageLoading.has(url)) {\r\n                                    awaitingForImageLoading.get(url).forEach(function (resolve) { return resolve(null); });\r\n                                    awaitingForImageLoading.delete(url);\r\n                                }\r\n                                return [2, absoluteValue];\r\n                            case 7:\r\n                                bgImageValue = getBgImageValue_1(imageDetails, filter) || absoluteValue;\r\n                                return [2, bgImageValue];\r\n                        }\r\n                    });\r\n                }); };\r\n            };\r\n            var getBgImageValue_1 = function (imageDetails, filter) {\r\n                var isDark = imageDetails.isDark, isLight = imageDetails.isLight, isTransparent = imageDetails.isTransparent, isLarge = imageDetails.isLarge, width = imageDetails.width;\r\n                var result;\r\n                if (isDark && isTransparent && filter.mode === 1 && !isLarge && width > 2) {\r\n                    logInfo(\"Inverting dark image \" + imageDetails.src);\r\n                    var inverted = getFilteredImageDataURL(imageDetails, __assign(__assign({}, filter), { sepia: clamp(filter.sepia + 10, 0, 100) }));\r\n                    result = \"url(\\\"\" + inverted + \"\\\")\";\r\n                }\r\n                else if (isLight && !isTransparent && filter.mode === 1) {\r\n                    if (isLarge) {\r\n                        result = 'none';\r\n                    }\r\n                    else {\r\n                        logInfo(\"Dimming light image \" + imageDetails.src);\r\n                        var dimmed = getFilteredImageDataURL(imageDetails, filter);\r\n                        result = \"url(\\\"\" + dimmed + \"\\\")\";\r\n                    }\r\n                }\r\n                else if (filter.mode === 0 && isLight && !isLarge) {\r\n                    logInfo(\"Applying filter to image \" + imageDetails.src);\r\n                    var filtered = getFilteredImageDataURL(imageDetails, __assign(__assign({}, filter), { brightness: clamp(filter.brightness - 10, 5, 200), sepia: clamp(filter.sepia + 10, 0, 100) }));\r\n                    result = \"url(\\\"\" + filtered + \"\\\")\";\r\n                }\r\n                else {\r\n                    result = null;\r\n                }\r\n                return result;\r\n            };\r\n            var modifiers_1 = [];\r\n            var index_1 = 0;\r\n            matches_1.forEach(function (_a, i) {\r\n                var match = _a.match, type = _a.type, matchStart = _a.index;\r\n                var prefixStart = index_1;\r\n                var matchEnd = matchStart + match.length;\r\n                index_1 = matchEnd;\r\n                modifiers_1.push(function () { return value.substring(prefixStart, matchStart); });\r\n                modifiers_1.push(type === 'url' ? getURLModifier_1(match) : getGradientModifier_1(match));\r\n                if (i === matches_1.length - 1) {\r\n                    modifiers_1.push(function () { return value.substring(matchEnd); });\r\n                }\r\n            });\r\n            return function (filter) {\r\n                var results = modifiers_1.map(function (modify) { return modify(filter); });\r\n                if (results.some(function (r) { return r instanceof Promise; })) {\r\n                    return Promise.all(results)\r\n                        .then(function (asyncResults) {\r\n                        return asyncResults.join('');\r\n                    });\r\n                }\r\n                return results.join('');\r\n            };\r\n        }\r\n        catch (err) {\r\n            logWarn(\"Unable to parse gradient \" + value, err);\r\n            return null;\r\n        }\r\n    }\r\n    function getShadowModifier(prop, value) {\r\n        try {\r\n            var index_2 = 0;\r\n            var colorMatches_1 = getMatches(/(^|\\s)([a-z]+\\(.+?\\)|#[0-9a-f]+|[a-z]+)(.*?(inset|outset)?($|,))/ig, value, 2);\r\n            var modifiers_2 = colorMatches_1.map(function (match, i) {\r\n                var prefixIndex = index_2;\r\n                var matchIndex = value.indexOf(match, index_2);\r\n                var matchEnd = matchIndex + match.length;\r\n                index_2 = matchEnd;\r\n                var rgb = tryParseColor(match);\r\n                if (!rgb) {\r\n                    return function () { return value.substring(prefixIndex, matchEnd); };\r\n                }\r\n                return function (filter) { return \"\" + value.substring(prefixIndex, matchIndex) + modifyShadowColor(rgb, filter) + (i === colorMatches_1.length - 1 ? value.substring(matchEnd) : ''); };\r\n            });\r\n            return function (filter) { return modifiers_2.map(function (modify) { return modify(filter); }).join(''); };\r\n        }\r\n        catch (err) {\r\n            logWarn(\"Unable to parse shadow \" + value, err);\r\n            return null;\r\n        }\r\n    }\r\n    function cleanModificationCache() {\r\n        colorParseCache.clear();\r\n        clearColorModificationCache();\r\n        imageDetailsCache.clear();\r\n        awaitingForImageLoading.clear();\r\n    }\n\n    var overrides = {\r\n        'background-color': {\r\n            customProp: '--darkreader-inline-bgcolor',\r\n            cssProp: 'background-color',\r\n            dataAttr: 'data-darkreader-inline-bgcolor',\r\n            store: new WeakSet(),\r\n        },\r\n        'background-image': {\r\n            customProp: '--darkreader-inline-bgimage',\r\n            cssProp: 'background-image',\r\n            dataAttr: 'data-darkreader-inline-bgimage',\r\n            store: new WeakSet(),\r\n        },\r\n        'border-color': {\r\n            customProp: '--darkreader-inline-border',\r\n            cssProp: 'border-color',\r\n            dataAttr: 'data-darkreader-inline-border',\r\n            store: new WeakSet(),\r\n        },\r\n        'border-bottom-color': {\r\n            customProp: '--darkreader-inline-border-bottom',\r\n            cssProp: 'border-bottom-color',\r\n            dataAttr: 'data-darkreader-inline-border-bottom',\r\n            store: new WeakSet(),\r\n        },\r\n        'border-left-color': {\r\n            customProp: '--darkreader-inline-border-left',\r\n            cssProp: 'border-left-color',\r\n            dataAttr: 'data-darkreader-inline-border-left',\r\n            store: new WeakSet(),\r\n        },\r\n        'border-right-color': {\r\n            customProp: '--darkreader-inline-border-right',\r\n            cssProp: 'border-right-color',\r\n            dataAttr: 'data-darkreader-inline-border-right',\r\n            store: new WeakSet(),\r\n        },\r\n        'border-top-color': {\r\n            customProp: '--darkreader-inline-border-top',\r\n            cssProp: 'border-top-color',\r\n            dataAttr: 'data-darkreader-inline-border-top',\r\n            store: new WeakSet(),\r\n        },\r\n        'box-shadow': {\r\n            customProp: '--darkreader-inline-boxshadow',\r\n            cssProp: 'box-shadow',\r\n            dataAttr: 'data-darkreader-inline-boxshadow',\r\n            store: new WeakSet(),\r\n        },\r\n        'color': {\r\n            customProp: '--darkreader-inline-color',\r\n            cssProp: 'color',\r\n            dataAttr: 'data-darkreader-inline-color',\r\n            store: new WeakSet(),\r\n        },\r\n        'fill': {\r\n            customProp: '--darkreader-inline-fill',\r\n            cssProp: 'fill',\r\n            dataAttr: 'data-darkreader-inline-fill',\r\n            store: new WeakSet(),\r\n        },\r\n        'stroke': {\r\n            customProp: '--darkreader-inline-stroke',\r\n            cssProp: 'stroke',\r\n            dataAttr: 'data-darkreader-inline-stroke',\r\n            store: new WeakSet(),\r\n        },\r\n        'outline-color': {\r\n            customProp: '--darkreader-inline-outline',\r\n            cssProp: 'outline-color',\r\n            dataAttr: 'data-darkreader-inline-outline',\r\n            store: new WeakSet(),\r\n        },\r\n    };\r\n    var overridesList = Object.values(overrides);\r\n    var INLINE_STYLE_ATTRS = ['style', 'fill', 'stroke', 'bgcolor', 'color'];\r\n    var INLINE_STYLE_SELECTOR = INLINE_STYLE_ATTRS.map(function (attr) { return \"[\" + attr + \"]\"; }).join(', ');\r\n    function getInlineOverrideStyle() {\r\n        return overridesList.map(function (_a) {\r\n            var dataAttr = _a.dataAttr, customProp = _a.customProp, cssProp = _a.cssProp;\r\n            return [\r\n                \"[\" + dataAttr + \"] {\",\r\n                \"  \" + cssProp + \": var(\" + customProp + \") !important;\",\r\n                '}',\r\n            ].join('\\n');\r\n        }).join('\\n');\r\n    }\r\n    function expand(nodes, selector) {\r\n        var results = [];\r\n        nodes.forEach(function (n) {\r\n            if (n instanceof Element) {\r\n                if (n.matches(selector)) {\r\n                    results.push(n);\r\n                }\r\n                results.push.apply(results, Array.from(n.querySelectorAll(selector)));\r\n            }\r\n        });\r\n        return results;\r\n    }\r\n    var observers = new Map();\r\n    function watchForInlineStyles(elementStyleDidChange, shadowRootDiscovered) {\r\n        deepWatchForInlineStyles(document.documentElement, elementStyleDidChange, shadowRootDiscovered);\r\n        iterateShadowNodes(document.documentElement, function (node) {\r\n            deepWatchForInlineStyles(node.shadowRoot, elementStyleDidChange, shadowRootDiscovered);\r\n        });\r\n    }\r\n    function deepWatchForInlineStyles(root, elementStyleDidChange, shadowRootDiscovered) {\r\n        if (observers.has(root)) {\r\n            observers.get(root).disconnect();\r\n        }\r\n        var observer = new MutationObserver(function (mutations) {\r\n            mutations.forEach(function (m) {\r\n                var createdInlineStyles = expand(Array.from(m.addedNodes), INLINE_STYLE_SELECTOR);\r\n                if (createdInlineStyles.length > 0) {\r\n                    createdInlineStyles.forEach(function (el) { return elementStyleDidChange(el); });\r\n                }\r\n                if (m.type === 'attributes') {\r\n                    if (INLINE_STYLE_ATTRS.includes(m.attributeName)) {\r\n                        elementStyleDidChange(m.target);\r\n                    }\r\n                    overridesList\r\n                        .filter(function (_a) {\r\n                        var store = _a.store, dataAttr = _a.dataAttr;\r\n                        return store.has(m.target) && !m.target.hasAttribute(dataAttr);\r\n                    })\r\n                        .forEach(function (_a) {\r\n                        var dataAttr = _a.dataAttr;\r\n                        return m.target.setAttribute(dataAttr, '');\r\n                    });\r\n                }\r\n            });\r\n            mutations.forEach(function (m) {\r\n                m.addedNodes.forEach(function (added) {\r\n                    if (added.isConnected) {\r\n                        iterateShadowNodes(added, function (n) {\r\n                            shadowRootDiscovered(n.shadowRoot);\r\n                            deepWatchForInlineStyles(n.shadowRoot, elementStyleDidChange, shadowRootDiscovered);\r\n                        });\r\n                    }\r\n                });\r\n            });\r\n        });\r\n        observer.observe(root, {\r\n            childList: true,\r\n            subtree: true,\r\n            attributes: true,\r\n            attributeFilter: INLINE_STYLE_ATTRS.concat(overridesList.map(function (_a) {\r\n                var dataAttr = _a.dataAttr;\r\n                return dataAttr;\r\n            })),\r\n        });\r\n        observers.set(root, observer);\r\n    }\r\n    function stopWatchingForInlineStyles() {\r\n        observers.forEach(function (o) { return o.disconnect(); });\r\n        observers.clear();\r\n    }\r\n    var inlineStyleCache = new WeakMap();\r\n    var filterProps = ['brightness', 'contrast', 'grayscale', 'sepia', 'mode'];\r\n    function getInlineStyleCacheKey(el, theme) {\r\n        return INLINE_STYLE_ATTRS\r\n            .map(function (attr) { return attr + \"=\\\"\" + el.getAttribute(attr) + \"\\\"\"; })\r\n            .concat(filterProps.map(function (prop) { return prop + \"=\\\"\" + theme[prop] + \"\\\"\"; }))\r\n            .join(' ');\r\n    }\r\n    function overrideInlineStyle(element, theme) {\r\n        var cacheKey = getInlineStyleCacheKey(element, theme);\r\n        if (cacheKey === inlineStyleCache.get(element)) {\r\n            return;\r\n        }\r\n        var unsetProps = new Set(Object.keys(overrides));\r\n        function setCustomProp(targetCSSProp, modifierCSSProp, cssVal) {\r\n            var _a = overrides[targetCSSProp], customProp = _a.customProp, dataAttr = _a.dataAttr;\r\n            var mod = getModifiableCSSDeclaration(modifierCSSProp, cssVal, null, null);\r\n            if (!mod) {\r\n                return;\r\n            }\r\n            var value = mod.value;\r\n            if (typeof value === 'function') {\r\n                value = value(theme);\r\n            }\r\n            element.style.setProperty(customProp, value);\r\n            if (!element.hasAttribute(dataAttr)) {\r\n                element.setAttribute(dataAttr, '');\r\n            }\r\n            unsetProps.delete(targetCSSProp);\r\n        }\r\n        if (element.hasAttribute('bgcolor')) {\r\n            var value = element.getAttribute('bgcolor');\r\n            if (value.match(/^[0-9a-f]{3}$/i) || value.match(/^[0-9a-f]{6}$/i)) {\r\n                value = \"#\" + value;\r\n            }\r\n            setCustomProp('background-color', 'background-color', value);\r\n        }\r\n        if (element.hasAttribute('color')) {\r\n            var value = element.getAttribute('color');\r\n            if (value.match(/^[0-9a-f]{3}$/i) || value.match(/^[0-9a-f]{6}$/i)) {\r\n                value = \"#\" + value;\r\n            }\r\n            setCustomProp('color', 'color', value);\r\n        }\r\n        if (element.hasAttribute('fill') && element instanceof SVGElement) {\r\n            var SMALL_SVG_LIMIT = 32;\r\n            var value = element.getAttribute('fill');\r\n            var isBg = false;\r\n            if (!(element instanceof SVGTextElement)) {\r\n                var _a = element.getBoundingClientRect(), width = _a.width, height = _a.height;\r\n                isBg = (width > SMALL_SVG_LIMIT || height > SMALL_SVG_LIMIT);\r\n            }\r\n            setCustomProp('fill', isBg ? 'background-color' : 'color', value);\r\n        }\r\n        if (element.hasAttribute('stroke')) {\r\n            var value = element.getAttribute('stroke');\r\n            setCustomProp('stroke', element instanceof SVGLineElement || element instanceof SVGTextElement ? 'border-color' : 'color', value);\r\n        }\r\n        element.style && iterateCSSDeclarations(element.style, function (property, value) {\r\n            if (property === 'background-image' && value.indexOf('url') >= 0) {\r\n                return;\r\n            }\r\n            if (overrides.hasOwnProperty(property)) {\r\n                setCustomProp(property, property, value);\r\n            }\r\n        });\r\n        if (element.style && element instanceof SVGTextElement && element.style.fill) {\r\n            setCustomProp('fill', 'color', element.style.getPropertyValue('fill'));\r\n        }\r\n        Array.from(unsetProps).forEach(function (cssProp) {\r\n            var _a = overrides[cssProp], store = _a.store, dataAttr = _a.dataAttr;\r\n            store.delete(element);\r\n            element.removeAttribute(dataAttr);\r\n        });\r\n        inlineStyleCache.set(element, getInlineStyleCacheKey(element, theme));\r\n    }\n\n    var metaThemeColorName = 'theme-color';\r\n    var metaThemeColorSelector = \"meta[name=\\\"\" + metaThemeColorName + \"\\\"]\";\r\n    var srcMetaThemeColor = null;\r\n    var observer = null;\r\n    function changeMetaThemeColor(meta, theme) {\r\n        srcMetaThemeColor = srcMetaThemeColor || meta.content;\r\n        try {\r\n            var color = parse(srcMetaThemeColor);\r\n            meta.content = modifyBackgroundColor(color, theme);\r\n        }\r\n        catch (err) {\r\n            logWarn(err);\r\n        }\r\n    }\r\n    function changeMetaThemeColorWhenAvailable(theme) {\r\n        var meta = document.querySelector(metaThemeColorSelector);\r\n        if (meta) {\r\n            changeMetaThemeColor(meta, theme);\r\n        }\r\n        else {\r\n            if (observer) {\r\n                observer.disconnect();\r\n            }\r\n            observer = new MutationObserver(function (mutations) {\r\n                loop: for (var _i = 0, mutations_1 = mutations; _i < mutations_1.length; _i++) {\r\n                    var m = mutations_1[_i];\r\n                    for (var _a = 0, _b = Array.from(m.addedNodes); _a < _b.length; _a++) {\r\n                        var node = _b[_a];\r\n                        if (node instanceof HTMLMetaElement && node.name === metaThemeColorName) {\r\n                            observer.disconnect();\r\n                            observer = null;\r\n                            changeMetaThemeColor(node, theme);\r\n                            break loop;\r\n                        }\r\n                    }\r\n                }\r\n            });\r\n            observer.observe(document.head, { childList: true });\r\n        }\r\n    }\r\n    function restoreMetaThemeColor() {\r\n        if (observer) {\r\n            observer.disconnect();\r\n            observer = null;\r\n        }\r\n        var meta = document.querySelector(metaThemeColorSelector);\r\n        if (meta && srcMetaThemeColor) {\r\n            meta.content = srcMetaThemeColor;\r\n        }\r\n    }\n\n    var STYLE_SELECTOR = (function () {\r\n        var selectors = [\r\n            'html /deep/ link[rel*=\"stylesheet\" i]:not([disabled])',\r\n            'html /deep/ style',\r\n            ':host /deep/ link[rel*=\"stylesheet\" i]:not([disabled])',\r\n            ':host /deep/ style',\r\n            ':host link[rel*=\"stylesheet\" i]:not([disabled])',\r\n            ':host style',\r\n        ];\r\n        if (!isDeepSelectorSupported()) {\r\n            selectors = selectors.map(function (s) { return s.replace('/deep/ ', ''); });\r\n        }\r\n        if (!isHostSelectorSupported()) {\r\n            selectors = selectors.filter(function (s) { return !s.startsWith(':host'); });\r\n        }\r\n        return selectors.join(', ');\r\n    })();\r\n    function shouldManageStyle(element) {\r\n        return (((element instanceof HTMLStyleElement) ||\r\n            (element instanceof SVGStyleElement) ||\r\n            (element instanceof HTMLLinkElement &&\r\n                element.rel &&\r\n                element.rel.toLowerCase().includes('stylesheet') &&\r\n                !element.disabled)) &&\r\n            !element.classList.contains('darkreader') &&\r\n            element.media !== 'print');\r\n    }\r\n    var asyncQueue = createAsyncTasksQueue();\r\n    function manageStyle(element, _a) {\r\n        var update = _a.update, loadingStart = _a.loadingStart, loadingEnd = _a.loadingEnd;\r\n        var prevStyles = [];\r\n        var next = element;\r\n        while ((next = next.nextElementSibling) && next.matches('.darkreader')) {\r\n            prevStyles.push(next);\r\n        }\r\n        var corsCopy = prevStyles.find(function (el) { return el.matches('.darkreader--cors'); }) || null;\r\n        var syncStyle = prevStyles.find(function (el) { return el.matches('.darkreader--sync'); }) || null;\r\n        var corsCopyPositionWatcher = null;\r\n        var syncStylePositionWatcher = null;\r\n        var cancelAsyncOperations = false;\r\n        function isCancelled() {\r\n            return cancelAsyncOperations;\r\n        }\r\n        var observer = new MutationObserver(function () {\r\n            update();\r\n        });\r\n        var observerOptions = { attributes: true, childList: true, characterData: true };\r\n        function containsCSSImport() {\r\n            return element instanceof HTMLStyleElement && element.textContent.trim().match(cssImportRegex);\r\n        }\r\n        function getRulesSync() {\r\n            if (corsCopy) {\r\n                return corsCopy.sheet.cssRules;\r\n            }\r\n            if (element.sheet == null) {\r\n                return null;\r\n            }\r\n            if (element instanceof HTMLLinkElement) {\r\n                try {\r\n                    return element.sheet.cssRules;\r\n                }\r\n                catch (err) {\r\n                    logWarn(err);\r\n                    return null;\r\n                }\r\n            }\r\n            if (containsCSSImport()) {\r\n                return null;\r\n            }\r\n            return safeGetSheetRules();\r\n        }\r\n        function insertStyle() {\r\n            if (corsCopy) {\r\n                if (element.nextSibling !== corsCopy) {\r\n                    element.parentNode.insertBefore(corsCopy, element.nextSibling);\r\n                }\r\n                if (corsCopy.nextSibling !== syncStyle) {\r\n                    element.parentNode.insertBefore(syncStyle, corsCopy.nextSibling);\r\n                }\r\n            }\r\n            else if (element.nextSibling !== syncStyle) {\r\n                element.parentNode.insertBefore(syncStyle, element.nextSibling);\r\n            }\r\n        }\r\n        function createSyncStyle() {\r\n            syncStyle = element instanceof SVGStyleElement ?\r\n                document.createElementNS('http://www.w3.org/2000/svg', 'style') :\r\n                document.createElement('style');\r\n            syncStyle.classList.add('darkreader');\r\n            syncStyle.classList.add('darkreader--sync');\r\n            syncStyle.media = 'screen';\r\n        }\r\n        var isLoadingRules = false;\r\n        var wasLoadingError = false;\r\n        function getRulesAsync() {\r\n            return __awaiter(this, void 0, void 0, function () {\r\n                var cssText, cssBasePath, err_1, fullCSSText, err_2;\r\n                return __generator(this, function (_a) {\r\n                    switch (_a.label) {\r\n                        case 0:\r\n                            if (!(element instanceof HTMLLinkElement)) return [3, 6];\r\n                            if (!(element.sheet == null)) return [3, 4];\r\n                            _a.label = 1;\r\n                        case 1:\r\n                            _a.trys.push([1, 3, , 4]);\r\n                            return [4, linkLoading(element)];\r\n                        case 2:\r\n                            _a.sent();\r\n                            if (cancelAsyncOperations) {\r\n                                return [2, null];\r\n                            }\r\n                            return [3, 4];\r\n                        case 3:\r\n                            err_1 = _a.sent();\r\n                            logWarn(err_1);\r\n                            wasLoadingError = true;\r\n                            return [2, null];\r\n                        case 4:\r\n                            try {\r\n                                if (element.sheet.cssRules != null) {\r\n                                    return [2, element.sheet.cssRules];\r\n                                }\r\n                            }\r\n                            catch (err) {\r\n                                logWarn(err);\r\n                            }\r\n                            return [4, loadText(element.href)];\r\n                        case 5:\r\n                            cssText = _a.sent();\r\n                            cssBasePath = getCSSBaseBath(element.href);\r\n                            if (cancelAsyncOperations) {\r\n                                return [2, null];\r\n                            }\r\n                            return [3, 7];\r\n                        case 6:\r\n                            if (containsCSSImport()) {\r\n                                cssText = element.textContent.trim();\r\n                                cssBasePath = getCSSBaseBath(location.href);\r\n                            }\r\n                            else {\r\n                                return [2, null];\r\n                            }\r\n                            _a.label = 7;\r\n                        case 7:\r\n                            if (!cssText) return [3, 12];\r\n                            _a.label = 8;\r\n                        case 8:\r\n                            _a.trys.push([8, 10, , 11]);\r\n                            return [4, replaceCSSImports(cssText, cssBasePath)];\r\n                        case 9:\r\n                            fullCSSText = _a.sent();\r\n                            corsCopy = createCORSCopy(element, fullCSSText);\r\n                            return [3, 11];\r\n                        case 10:\r\n                            err_2 = _a.sent();\r\n                            logWarn(err_2);\r\n                            return [3, 11];\r\n                        case 11:\r\n                            if (corsCopy) {\r\n                                corsCopyPositionWatcher = watchForNodePosition(corsCopy, { watchParent: true, watchSibling: true });\r\n                                return [2, corsCopy.sheet.cssRules];\r\n                            }\r\n                            _a.label = 12;\r\n                        case 12: return [2, null];\r\n                    }\r\n                });\r\n            });\r\n        }\r\n        function details() {\r\n            var rules = getRulesSync();\r\n            if (!rules) {\r\n                if (isLoadingRules || wasLoadingError) {\r\n                    return null;\r\n                }\r\n                isLoadingRules = true;\r\n                loadingStart();\r\n                getRulesAsync().then(function (results) {\r\n                    isLoadingRules = false;\r\n                    loadingEnd();\r\n                    if (results) {\r\n                        update();\r\n                    }\r\n                }).catch(function (err) {\r\n                    logWarn(err);\r\n                    isLoadingRules = false;\r\n                    loadingEnd();\r\n                });\r\n                return null;\r\n            }\r\n            var variables = getCSSVariables(rules);\r\n            return { variables: variables };\r\n        }\r\n        function getFilterKey(filter) {\r\n            return ['mode', 'brightness', 'contrast', 'grayscale', 'sepia'].map(function (p) { return p + \":\" + filter[p]; }).join(';');\r\n        }\r\n        var renderId = 0;\r\n        var rulesTextCache = new Map();\r\n        var rulesModCache = new Map();\r\n        var prevFilterKey = null;\r\n        var forceRestore = false;\r\n        function render(filter, variables) {\r\n            var rules = getRulesSync();\r\n            if (!rules) {\r\n                return;\r\n            }\r\n            cancelAsyncOperations = false;\r\n            var rulesChanged = (rulesModCache.size === 0);\r\n            var notFoundCacheKeys = new Set(rulesModCache.keys());\r\n            var filterKey = getFilterKey(filter);\r\n            var filterChanged = (filterKey !== prevFilterKey);\r\n            var modRules = [];\r\n            iterateCSSRules(rules, function (rule) {\r\n                var cssText = rule.cssText;\r\n                var textDiffersFromPrev = false;\r\n                notFoundCacheKeys.delete(cssText);\r\n                if (!rulesTextCache.has(cssText)) {\r\n                    rulesTextCache.set(cssText, cssText);\r\n                    textDiffersFromPrev = true;\r\n                }\r\n                var vars = null;\r\n                var varsRule = null;\r\n                if (variables.size > 0 || cssText.includes('var(')) {\r\n                    var cssTextWithVariables = replaceCSSVariables(cssText, variables);\r\n                    if (rulesTextCache.get(cssText) !== cssTextWithVariables) {\r\n                        rulesTextCache.set(cssText, cssTextWithVariables);\r\n                        textDiffersFromPrev = true;\r\n                        vars = document.createElement('style');\r\n                        vars.classList.add('darkreader');\r\n                        vars.classList.add('darkreader--vars');\r\n                        vars.media = 'screen';\r\n                        vars.textContent = cssTextWithVariables;\r\n                        element.parentNode.insertBefore(vars, element.nextSibling);\r\n                        varsRule = vars.sheet.cssRules[0];\r\n                    }\r\n                }\r\n                if (textDiffersFromPrev) {\r\n                    rulesChanged = true;\r\n                }\r\n                else {\r\n                    modRules.push(rulesModCache.get(cssText));\r\n                    return;\r\n                }\r\n                var modDecs = [];\r\n                var targetRule = varsRule || rule;\r\n                targetRule && targetRule.style && iterateCSSDeclarations(targetRule.style, function (property, value) {\r\n                    var mod = getModifiableCSSDeclaration(property, value, rule, isCancelled);\r\n                    if (mod) {\r\n                        modDecs.push(mod);\r\n                    }\r\n                });\r\n                var modRule = null;\r\n                if (modDecs.length > 0) {\r\n                    modRule = { selector: rule.selectorText, declarations: modDecs };\r\n                    if (rule.parentRule instanceof CSSMediaRule) {\r\n                        modRule.media = rule.parentRule.media.mediaText;\r\n                    }\r\n                    modRules.push(modRule);\r\n                }\r\n                rulesModCache.set(cssText, modRule);\r\n                removeNode(vars);\r\n            });\r\n            notFoundCacheKeys.forEach(function (key) {\r\n                rulesTextCache.delete(key);\r\n                rulesModCache.delete(key);\r\n            });\r\n            prevFilterKey = filterKey;\r\n            if (!forceRestore && !rulesChanged && !filterChanged) {\r\n                return;\r\n            }\r\n            renderId++;\r\n            forceRestore = false;\r\n            function setRule(target, index, declarations) {\r\n                var selector = declarations[0].selector;\r\n                target.insertRule(selector + \" {}\", index);\r\n                var style = target.cssRules.item(index).style;\r\n                declarations.forEach(function (_a) {\r\n                    var property = _a.property, value = _a.value, important = _a.important, sourceValue = _a.sourceValue;\r\n                    style.setProperty(property, value == null ? sourceValue : value, important ? 'important' : '');\r\n                });\r\n            }\r\n            var readyDeclarations = [];\r\n            var asyncDeclarations = new Map();\r\n            var asyncDeclarationCounter = 0;\r\n            function buildStyleSheet() {\r\n                var groups = [];\r\n                readyDeclarations.forEach(function (decl, i) {\r\n                    var mediaGroup;\r\n                    var selectorGroup;\r\n                    var prev = i === 0 ? null : readyDeclarations[i - 1];\r\n                    var isSameMedia = prev && prev.media === decl.media;\r\n                    var isSameMediaAndSelector = prev && isSameMedia && prev.selector === decl.selector;\r\n                    if (isSameMedia) {\r\n                        mediaGroup = groups[groups.length - 1];\r\n                    }\r\n                    else {\r\n                        mediaGroup = [];\r\n                        groups.push(mediaGroup);\r\n                    }\r\n                    if (isSameMediaAndSelector) {\r\n                        selectorGroup = mediaGroup[mediaGroup.length - 1];\r\n                    }\r\n                    else {\r\n                        selectorGroup = [];\r\n                        mediaGroup.push(selectorGroup);\r\n                    }\r\n                    selectorGroup.push(decl);\r\n                });\r\n                if (!syncStyle) {\r\n                    createSyncStyle();\r\n                }\r\n                syncStylePositionWatcher && syncStylePositionWatcher.stop();\r\n                insertStyle();\r\n                var sheet = syncStyle.sheet;\r\n                for (var i = sheet.cssRules.length - 1; i >= 0; i--) {\r\n                    sheet.deleteRule(i);\r\n                }\r\n                groups.forEach(function (mediaGroup) {\r\n                    var media = mediaGroup[0][0].media;\r\n                    var target;\r\n                    if (media) {\r\n                        sheet.insertRule(\"@media \" + media + \" {}\", sheet.cssRules.length);\r\n                        target = sheet.cssRules[sheet.cssRules.length - 1];\r\n                    }\r\n                    else {\r\n                        target = sheet;\r\n                    }\r\n                    mediaGroup.forEach(function (selectorGroup) {\r\n                        var asyncItems = selectorGroup.filter(function (_a) {\r\n                            var value = _a.value;\r\n                            return value == null;\r\n                        });\r\n                        if (asyncItems.length > 0) {\r\n                            asyncItems.forEach(function (_a) {\r\n                                var asyncKey = _a.asyncKey;\r\n                                return asyncDeclarations.set(asyncKey, { declarations: selectorGroup, target: target, index: target.cssRules.length });\r\n                            });\r\n                        }\r\n                        setRule(target, target.cssRules.length, selectorGroup);\r\n                    });\r\n                });\r\n                if (syncStylePositionWatcher) {\r\n                    syncStylePositionWatcher.run();\r\n                }\r\n                else {\r\n                    syncStylePositionWatcher = watchForNodePosition(syncStyle, { onRestore: buildStyleSheet, watchSibling: true, watchParent: true });\r\n                }\r\n            }\r\n            function rebuildAsyncRule(key) {\r\n                var _a = asyncDeclarations.get(key), declarations = _a.declarations, target = _a.target, index = _a.index;\r\n                target.deleteRule(index);\r\n                setRule(target, index, declarations);\r\n                asyncDeclarations.delete(key);\r\n            }\r\n            modRules.filter(function (r) { return r; }).forEach(function (_a) {\r\n                var selector = _a.selector, declarations = _a.declarations, media = _a.media;\r\n                declarations.forEach(function (_a) {\r\n                    var property = _a.property, value = _a.value, important = _a.important, sourceValue = _a.sourceValue;\r\n                    if (typeof value === 'function') {\r\n                        var modified = value(filter);\r\n                        if (modified instanceof Promise) {\r\n                            var index_1 = readyDeclarations.length;\r\n                            var asyncKey_1 = asyncDeclarationCounter++;\r\n                            readyDeclarations.push({ media: media, selector: selector, property: property, value: null, important: important, asyncKey: asyncKey_1, sourceValue: sourceValue });\r\n                            var promise = modified;\r\n                            var currentRenderId_1 = renderId;\r\n                            promise.then(function (asyncValue) {\r\n                                if (!asyncValue || cancelAsyncOperations || currentRenderId_1 !== renderId) {\r\n                                    return;\r\n                                }\r\n                                readyDeclarations[index_1].value = asyncValue;\r\n                                asyncQueue.add(function () {\r\n                                    if (cancelAsyncOperations || currentRenderId_1 !== renderId) {\r\n                                        return;\r\n                                    }\r\n                                    rebuildAsyncRule(asyncKey_1);\r\n                                });\r\n                            });\r\n                        }\r\n                        else {\r\n                            readyDeclarations.push({ media: media, selector: selector, property: property, value: modified, important: important, sourceValue: sourceValue });\r\n                        }\r\n                    }\r\n                    else {\r\n                        readyDeclarations.push({ media: media, selector: selector, property: property, value: value, important: important, sourceValue: sourceValue });\r\n                    }\r\n                });\r\n            });\r\n            buildStyleSheet();\r\n        }\r\n        var rulesChangeKey = null;\r\n        var rulesCheckFrameId = null;\r\n        function safeGetSheetRules() {\r\n            try {\r\n                if (element.sheet == null) {\r\n                    return null;\r\n                }\r\n                return element.sheet.cssRules;\r\n            }\r\n            catch (err) {\r\n                logWarn(err);\r\n                return null;\r\n            }\r\n        }\r\n        function updateRulesChangeKey() {\r\n            var rules = safeGetSheetRules();\r\n            if (rules) {\r\n                rulesChangeKey = rules.length;\r\n            }\r\n        }\r\n        function didRulesKeyChange() {\r\n            var rules = safeGetSheetRules();\r\n            return rules && rules.length !== rulesChangeKey;\r\n        }\r\n        function subscribeToSheetChanges() {\r\n            updateRulesChangeKey();\r\n            unsubscribeFromSheetChanges();\r\n            var checkForUpdate = function () {\r\n                if (didRulesKeyChange()) {\r\n                    updateRulesChangeKey();\r\n                    update();\r\n                }\r\n                rulesCheckFrameId = requestAnimationFrame(checkForUpdate);\r\n            };\r\n            checkForUpdate();\r\n        }\r\n        function unsubscribeFromSheetChanges() {\r\n            cancelAnimationFrame(rulesCheckFrameId);\r\n        }\r\n        function pause() {\r\n            observer.disconnect();\r\n            cancelAsyncOperations = true;\r\n            corsCopyPositionWatcher && corsCopyPositionWatcher.stop();\r\n            syncStylePositionWatcher && syncStylePositionWatcher.stop();\r\n            unsubscribeFromSheetChanges();\r\n        }\r\n        function destroy() {\r\n            pause();\r\n            removeNode(corsCopy);\r\n            removeNode(syncStyle);\r\n        }\r\n        function watch() {\r\n            observer.observe(element, observerOptions);\r\n            if (element instanceof HTMLStyleElement) {\r\n                subscribeToSheetChanges();\r\n            }\r\n        }\r\n        var maxMoveCount = 10;\r\n        var moveCount = 0;\r\n        function restore() {\r\n            if (!syncStyle) {\r\n                return;\r\n            }\r\n            moveCount++;\r\n            if (moveCount > maxMoveCount) {\r\n                logWarn('Style sheet was moved multiple times', element);\r\n                return;\r\n            }\r\n            logWarn('Restore style', syncStyle, element);\r\n            var shouldRestore = syncStyle.sheet == null || syncStyle.sheet.cssRules.length > 0;\r\n            insertStyle();\r\n            if (shouldRestore) {\r\n                forceRestore = true;\r\n                updateRulesChangeKey();\r\n                update();\r\n            }\r\n        }\r\n        return {\r\n            details: details,\r\n            render: render,\r\n            pause: pause,\r\n            destroy: destroy,\r\n            watch: watch,\r\n            restore: restore,\r\n        };\r\n    }\r\n    function linkLoading(link) {\r\n        return new Promise(function (resolve, reject) {\r\n            var cleanUp = function () {\r\n                link.removeEventListener('load', onLoad);\r\n                link.removeEventListener('error', onError);\r\n            };\r\n            var onLoad = function () {\r\n                cleanUp();\r\n                resolve();\r\n            };\r\n            var onError = function () {\r\n                cleanUp();\r\n                reject(\"Link loading failed \" + link.href);\r\n            };\r\n            link.addEventListener('load', onLoad);\r\n            link.addEventListener('error', onError);\r\n        });\r\n    }\r\n    function getCSSImportURL(importDeclaration) {\r\n        return getCSSURLValue(importDeclaration.substring(8).replace(/;$/, ''));\r\n    }\r\n    function loadText(url) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        if (!url.startsWith('data:')) return [3, 3];\r\n                        return [4, fetch(url)];\r\n                    case 1: return [4, (_a.sent()).text()];\r\n                    case 2: return [2, _a.sent()];\r\n                    case 3: return [4, bgFetch({ url: url, responseType: 'text', mimeType: 'text/css' })];\r\n                    case 4: return [2, _a.sent()];\r\n                }\r\n            });\r\n        });\r\n    }\r\n    function replaceCSSImports(cssText, basePath) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var importMatches, _i, importMatches_1, match, importURL, absoluteURL, importedCSS, err_3;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0:\r\n                        cssText = removeCSSComments(cssText);\r\n                        cssText = replaceCSSFontFace(cssText);\r\n                        cssText = replaceCSSRelativeURLsWithAbsolute(cssText, basePath);\r\n                        importMatches = getMatches(cssImportRegex, cssText);\r\n                        _i = 0, importMatches_1 = importMatches;\r\n                        _a.label = 1;\r\n                    case 1:\r\n                        if (!(_i < importMatches_1.length)) return [3, 8];\r\n                        match = importMatches_1[_i];\r\n                        importURL = getCSSImportURL(match);\r\n                        absoluteURL = getAbsoluteURL(basePath, importURL);\r\n                        importedCSS = void 0;\r\n                        _a.label = 2;\r\n                    case 2:\r\n                        _a.trys.push([2, 5, , 6]);\r\n                        return [4, loadText(absoluteURL)];\r\n                    case 3:\r\n                        importedCSS = _a.sent();\r\n                        return [4, replaceCSSImports(importedCSS, getCSSBaseBath(absoluteURL))];\r\n                    case 4:\r\n                        importedCSS = _a.sent();\r\n                        return [3, 6];\r\n                    case 5:\r\n                        err_3 = _a.sent();\r\n                        logWarn(err_3);\r\n                        importedCSS = '';\r\n                        return [3, 6];\r\n                    case 6:\r\n                        cssText = cssText.split(match).join(importedCSS);\r\n                        _a.label = 7;\r\n                    case 7:\r\n                        _i++;\r\n                        return [3, 1];\r\n                    case 8:\r\n                        cssText = cssText.trim();\r\n                        return [2, cssText];\r\n                }\r\n            });\r\n        });\r\n    }\r\n    function createCORSCopy(srcElement, cssText) {\r\n        if (!cssText) {\r\n            return null;\r\n        }\r\n        var cors = document.createElement('style');\r\n        cors.classList.add('darkreader');\r\n        cors.classList.add('darkreader--cors');\r\n        cors.media = 'screen';\r\n        cors.textContent = cssText;\r\n        srcElement.parentNode.insertBefore(cors, srcElement.nextSibling);\r\n        cors.sheet.disabled = true;\r\n        return cors;\r\n    }\n\n    var observer$1 = null;\r\n    function getAllManageableStyles(nodes) {\r\n        var results = [];\r\n        Array.from(nodes).forEach(function (node) {\r\n            if (node instanceof Element) {\r\n                if (shouldManageStyle(node)) {\r\n                    results.push(node);\r\n                }\r\n            }\r\n            if (node instanceof Element || node instanceof ShadowRoot) {\r\n                results.push.apply(results, Array.from(node.querySelectorAll(STYLE_SELECTOR)).filter(shouldManageStyle));\r\n            }\r\n        });\r\n        return results;\r\n    }\r\n    var undefinedGroups = new Map();\r\n    var elementsDefinitionCallback;\r\n    function collectUndefinedElements(root) {\r\n        if (!isDefinedSelectorSupported()) {\r\n            return;\r\n        }\r\n        root.querySelectorAll(':not(:defined)')\r\n            .forEach(function (el) {\r\n            var tag = el.tagName.toLowerCase();\r\n            if (!undefinedGroups.has(tag)) {\r\n                undefinedGroups.set(tag, new Set());\r\n                customElementsWhenDefined(tag).then(function () {\r\n                    if (elementsDefinitionCallback) {\r\n                        var elements = undefinedGroups.get(tag);\r\n                        undefinedGroups.delete(tag);\r\n                        elementsDefinitionCallback(Array.from(elements));\r\n                    }\r\n                });\r\n            }\r\n            undefinedGroups.get(tag).add(el);\r\n        });\r\n    }\r\n    function customElementsWhenDefined(tag) {\r\n        return new Promise(function (resolve) {\r\n            if (window.customElements && typeof window.customElements.whenDefined === 'function') {\r\n                customElements.whenDefined(tag).then(resolve);\r\n            }\r\n            else {\r\n                var checkIfDefined_1 = function () {\r\n                    var elements = undefinedGroups.get(tag);\r\n                    if (elements && elements.size > 0) {\r\n                        if (elements.values().next().value.matches(':defined')) {\r\n                            resolve();\r\n                        }\r\n                        else {\r\n                            requestAnimationFrame(checkIfDefined_1);\r\n                        }\r\n                    }\r\n                };\r\n                requestAnimationFrame(checkIfDefined_1);\r\n            }\r\n        });\r\n    }\r\n    function watchWhenCustomElementsDefined(callback) {\r\n        elementsDefinitionCallback = callback;\r\n    }\r\n    function unsubscribeFromDefineCustomElements() {\r\n        elementsDefinitionCallback = null;\r\n        undefinedGroups.clear();\r\n    }\r\n    var shadowObservers = new Set();\r\n    var nodesShadowObservers = new WeakMap();\r\n    function unsubscribeFromShadowRootChanges() {\r\n        shadowObservers.forEach(function (o) { return o.disconnect(); });\r\n        shadowObservers.clear();\r\n        nodesShadowObservers = new WeakMap();\r\n    }\r\n    function watchForStyleChanges(update) {\r\n        if (observer$1) {\r\n            observer$1.disconnect();\r\n            shadowObservers.forEach(function (o) { return o.disconnect(); });\r\n            shadowObservers.clear();\r\n            nodesShadowObservers = new WeakMap();\r\n        }\r\n        function handleMutations(mutations) {\r\n            var createdStyles = new Set();\r\n            var updatedStyles = new Set();\r\n            var removedStyles = new Set();\r\n            var movedStyles = new Set();\r\n            var additions = new Set();\r\n            var deletions = new Set();\r\n            var styleUpdates = new Set();\r\n            mutations.forEach(function (m) {\r\n                m.addedNodes.forEach(function (n) { return additions.add(n); });\r\n                m.removedNodes.forEach(function (n) { return deletions.add(n); });\r\n                if (m.type === 'attributes' && shouldManageStyle(m.target)) {\r\n                    styleUpdates.add(m.target);\r\n                }\r\n            });\r\n            var styleAdditions = getAllManageableStyles(additions);\r\n            var styleDeletions = getAllManageableStyles(deletions);\r\n            additions.forEach(function (n) {\r\n                iterateShadowNodes(n, function (host) {\r\n                    var shadowStyles = getAllManageableStyles(host.shadowRoot.children);\r\n                    if (shadowStyles.length > 0) {\r\n                        styleAdditions.push.apply(styleAdditions, shadowStyles);\r\n                    }\r\n                });\r\n            });\r\n            deletions.forEach(function (n) {\r\n                iterateShadowNodes(n, function (host) {\r\n                    var shadowStyles = getAllManageableStyles(host.shadowRoot.children);\r\n                    if (shadowStyles.length > 0) {\r\n                        styleDeletions.push.apply(styleDeletions, shadowStyles);\r\n                    }\r\n                });\r\n            });\r\n            styleDeletions.forEach(function (style) {\r\n                if (style.isConnected) {\r\n                    movedStyles.add(style);\r\n                }\r\n                else {\r\n                    removedStyles.add(style);\r\n                }\r\n            });\r\n            styleUpdates.forEach(function (style) {\r\n                if (!removedStyles.has(style)) {\r\n                    updatedStyles.add(style);\r\n                }\r\n            });\r\n            styleAdditions.forEach(function (style) {\r\n                if (!(removedStyles.has(style) || movedStyles.has(style) || updatedStyles.has(style))) {\r\n                    createdStyles.add(style);\r\n                }\r\n            });\r\n            if (createdStyles.size + removedStyles.size + updatedStyles.size > 0) {\r\n                update({\r\n                    created: Array.from(createdStyles),\r\n                    updated: Array.from(updatedStyles),\r\n                    removed: Array.from(removedStyles),\r\n                    moved: Array.from(movedStyles),\r\n                });\r\n            }\r\n            additions.forEach(function (n) {\r\n                if (n.isConnected) {\r\n                    iterateShadowNodes(n, subscribeForShadowRootChanges);\r\n                    if (n instanceof Element) {\r\n                        collectUndefinedElements(n);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n        function subscribeForShadowRootChanges(node) {\r\n            if (nodesShadowObservers.has(node)) {\r\n                return;\r\n            }\r\n            var shadowObserver = new MutationObserver(handleMutations);\r\n            shadowObserver.observe(node.shadowRoot, mutationObserverOptions);\r\n            shadowObservers.add(shadowObserver);\r\n            nodesShadowObservers.set(node, shadowObserver);\r\n        }\r\n        var mutationObserverOptions = { childList: true, subtree: true, attributes: true, attributeFilter: ['rel', 'disabled'] };\r\n        observer$1 = new MutationObserver(handleMutations);\r\n        observer$1.observe(document.documentElement, mutationObserverOptions);\r\n        iterateShadowNodes(document.documentElement, subscribeForShadowRootChanges);\r\n        watchWhenCustomElementsDefined(function (hosts) {\r\n            var newStyles = getAllManageableStyles(hosts.map(function (h) { return h.shadowRoot; }));\r\n            update({ created: newStyles, updated: [], removed: [], moved: [] });\r\n            hosts.forEach(function (h) { return subscribeForShadowRootChanges(h); });\r\n        });\r\n        collectUndefinedElements(document);\r\n    }\r\n    function stopWatchingForStyleChanges() {\r\n        if (observer$1) {\r\n            observer$1.disconnect();\r\n            observer$1 = null;\r\n            unsubscribeFromShadowRootChanges();\r\n            unsubscribeFromDefineCustomElements();\r\n        }\r\n    }\n\n    var styleManagers = new Map();\r\n    var variables = new Map();\r\n    var filter = null;\r\n    var fixes = null;\r\n    var isIFrame = null;\r\n    function createOrUpdateStyle(className, root) {\r\n        if (root === void 0) { root = document.head || document; }\r\n        var style = root.querySelector(\".\" + className);\r\n        if (!style) {\r\n            style = document.createElement('style');\r\n            style.classList.add('darkreader');\r\n            style.classList.add(className);\r\n            style.media = 'screen';\r\n        }\r\n        return style;\r\n    }\r\n    var stylePositionWatchers = new Map();\r\n    function setupStylePositionWatcher(node, alias) {\r\n        stylePositionWatchers.has(alias) && stylePositionWatchers.get(alias).stop();\r\n        stylePositionWatchers.set(alias, watchForNodePosition(node, { watchParent: true, watchSibling: false }));\r\n    }\r\n    function stopStylePositionWatchers() {\r\n        Array.from(stylePositionWatchers.values()).forEach(function (watcher) { return watcher.stop(); });\r\n        stylePositionWatchers.clear();\r\n    }\r\n    function createStaticStyleOverrides() {\r\n        var fallbackStyle = createOrUpdateStyle('darkreader--fallback');\r\n        document.head.insertBefore(fallbackStyle, document.head.firstChild);\r\n        fallbackStyle.textContent = getModifiedFallbackStyle(filter, { strict: true });\r\n        setupStylePositionWatcher(fallbackStyle, 'fallback');\r\n        var userAgentStyle = createOrUpdateStyle('darkreader--user-agent');\r\n        document.head.insertBefore(userAgentStyle, fallbackStyle.nextSibling);\r\n        userAgentStyle.textContent = getModifiedUserAgentStyle(filter, isIFrame);\r\n        setupStylePositionWatcher(userAgentStyle, 'user-agent');\r\n        var textStyle = createOrUpdateStyle('darkreader--text');\r\n        document.head.insertBefore(textStyle, fallbackStyle.nextSibling);\r\n        if (filter.useFont || filter.textStroke > 0) {\r\n            textStyle.textContent = createTextStyle(filter);\r\n        }\r\n        else {\r\n            textStyle.textContent = '';\r\n        }\r\n        setupStylePositionWatcher(textStyle, 'text');\r\n        var invertStyle = createOrUpdateStyle('darkreader--invert');\r\n        document.head.insertBefore(invertStyle, textStyle.nextSibling);\r\n        if (fixes && Array.isArray(fixes.invert) && fixes.invert.length > 0) {\r\n            invertStyle.textContent = [\r\n                fixes.invert.join(', ') + \" {\",\r\n                \"    filter: \" + getCSSFilterValue(__assign(__assign({}, filter), { contrast: filter.mode === 0 ? filter.contrast : clamp(filter.contrast - 10, 0, 100) })) + \" !important;\",\r\n                '}',\r\n            ].join('\\n');\r\n        }\r\n        else {\r\n            invertStyle.textContent = '';\r\n        }\r\n        setupStylePositionWatcher(invertStyle, 'invert');\r\n        var inlineStyle = createOrUpdateStyle('darkreader--inline');\r\n        document.head.insertBefore(inlineStyle, invertStyle.nextSibling);\r\n        inlineStyle.textContent = getInlineOverrideStyle();\r\n        setupStylePositionWatcher(inlineStyle, 'inline');\r\n        var overrideStyle = createOrUpdateStyle('darkreader--override');\r\n        document.head.appendChild(overrideStyle);\r\n        overrideStyle.textContent = fixes && fixes.css ? replaceCSSTemplates(fixes.css) : '';\r\n        setupStylePositionWatcher(overrideStyle, 'override');\r\n    }\r\n    var shadowRootsWithOverrides = new Set();\r\n    function createShadowStaticStyleOverrides(root) {\r\n        var inlineStyle = createOrUpdateStyle('darkreader--inline', root);\r\n        root.insertBefore(inlineStyle, root.firstChild);\r\n        inlineStyle.textContent = getInlineOverrideStyle();\r\n        shadowRootsWithOverrides.add(root);\r\n    }\r\n    function replaceCSSTemplates($cssText) {\r\n        return $cssText.replace(/\\${(.+?)}/g, function (m0, $color) {\r\n            try {\r\n                var color = parseColorWithCache($color);\r\n                return modifyColor(color, filter);\r\n            }\r\n            catch (err) {\r\n                logWarn(err);\r\n                return $color;\r\n            }\r\n        });\r\n    }\r\n    function cleanFallbackStyle() {\r\n        var fallback = document.head.querySelector('.darkreader--fallback');\r\n        if (fallback) {\r\n            fallback.textContent = '';\r\n        }\r\n    }\r\n    function createDynamicStyleOverrides() {\r\n        cancelRendering();\r\n        updateVariables(getElementCSSVariables(document.documentElement));\r\n        var allStyles = Array.from(document.querySelectorAll(STYLE_SELECTOR));\r\n        iterateShadowNodes(document.documentElement, function (node) {\r\n            var shadowStyles = node.shadowRoot.querySelectorAll(STYLE_SELECTOR);\r\n            if (shadowStyles.length > 0) {\r\n                allStyles.push.apply(allStyles, Array.from(shadowStyles));\r\n            }\r\n        });\r\n        var newManagers = Array.from(allStyles)\r\n            .filter(function (style) { return !styleManagers.has(style) && shouldManageStyle(style); })\r\n            .map(function (style) { return createManager(style); });\r\n        var newVariables = newManagers\r\n            .map(function (manager) { return manager.details(); })\r\n            .filter(function (details) { return details && details.variables.size > 0; })\r\n            .map(function (_a) {\r\n            var variables = _a.variables;\r\n            return variables;\r\n        });\r\n        if (newVariables.length === 0) {\r\n            styleManagers.forEach(function (manager) { return manager.render(filter, variables); });\r\n            if (loadingStyles.size === 0) {\r\n                cleanFallbackStyle();\r\n            }\r\n        }\r\n        else {\r\n            newVariables.forEach(function (variables) { return updateVariables(variables); });\r\n            throttledRenderAllStyles(function () {\r\n                if (loadingStyles.size === 0) {\r\n                    cleanFallbackStyle();\r\n                }\r\n            });\r\n        }\r\n        newManagers.forEach(function (manager) { return manager.watch(); });\r\n        var inlineStyleElements = Array.from(document.querySelectorAll(INLINE_STYLE_SELECTOR));\r\n        iterateShadowNodes(document.documentElement, function (node) {\r\n            var elements = node.shadowRoot.querySelectorAll(INLINE_STYLE_SELECTOR);\r\n            if (elements.length > 0) {\r\n                createShadowStaticStyleOverrides(node.shadowRoot);\r\n                inlineStyleElements.push.apply(inlineStyleElements, Array.from(elements));\r\n            }\r\n        });\r\n        inlineStyleElements.forEach(function (el) { return overrideInlineStyle(el, filter); });\r\n    }\r\n    var loadingStylesCounter = 0;\r\n    var loadingStyles = new Set();\r\n    function createManager(element) {\r\n        if (styleManagers.has(element)) {\r\n            return;\r\n        }\r\n        var loadingStyleId = ++loadingStylesCounter;\r\n        function loadingStart() {\r\n            if (!isPageLoaded() || !didDocumentShowUp) {\r\n                loadingStyles.add(loadingStyleId);\r\n                var fallbackStyle = document.querySelector('.darkreader--fallback');\r\n                if (!fallbackStyle.textContent) {\r\n                    fallbackStyle.textContent = getModifiedFallbackStyle(filter, { strict: false });\r\n                }\r\n            }\r\n        }\r\n        function loadingEnd() {\r\n            loadingStyles.delete(loadingStyleId);\r\n            if (loadingStyles.size === 0 && isPageLoaded()) {\r\n                cleanFallbackStyle();\r\n            }\r\n        }\r\n        function update() {\r\n            var details = manager.details();\r\n            if (!details) {\r\n                return;\r\n            }\r\n            if (details.variables.size === 0) {\r\n                manager.render(filter, variables);\r\n            }\r\n            else {\r\n                updateVariables(details.variables);\r\n                throttledRenderAllStyles();\r\n            }\r\n        }\r\n        var manager = manageStyle(element, { update: update, loadingStart: loadingStart, loadingEnd: loadingEnd });\r\n        styleManagers.set(element, manager);\r\n        return manager;\r\n    }\r\n    function updateVariables(newVars) {\r\n        if (newVars.size === 0) {\r\n            return;\r\n        }\r\n        newVars.forEach(function (value, key) { return variables.set(key, value); });\r\n        variables.forEach(function (value, key) { return variables.set(key, replaceCSSVariables(value, variables)); });\r\n    }\r\n    function removeManager(element) {\r\n        var manager = styleManagers.get(element);\r\n        if (manager) {\r\n            manager.destroy();\r\n            styleManagers.delete(element);\r\n        }\r\n    }\r\n    var throttledRenderAllStyles = throttle(function (callback) {\r\n        styleManagers.forEach(function (manager) { return manager.render(filter, variables); });\r\n        callback && callback();\r\n    });\r\n    var cancelRendering = function () {\r\n        throttledRenderAllStyles.cancel();\r\n    };\r\n    function isPageLoaded() {\r\n        return document.readyState === 'complete' || document.readyState === 'interactive';\r\n    }\r\n    function onReadyStateChange() {\r\n        if (!isPageLoaded()) {\r\n            return;\r\n        }\r\n        document.removeEventListener('readystatechange', onReadyStateChange);\r\n        if (loadingStyles.size === 0) {\r\n            cleanFallbackStyle();\r\n        }\r\n    }\r\n    var documentVisibilityListener = null;\r\n    var didDocumentShowUp = !document.hidden;\r\n    function watchForDocumentVisibility(callback) {\r\n        var alreadyWatching = Boolean(documentVisibilityListener);\r\n        documentVisibilityListener = function () {\r\n            if (!document.hidden) {\r\n                stopWatchingForDocumentVisibility();\r\n                callback();\r\n                didDocumentShowUp = true;\r\n            }\r\n        };\r\n        if (!alreadyWatching) {\r\n            document.addEventListener('visibilitychange', documentVisibilityListener);\r\n        }\r\n    }\r\n    function stopWatchingForDocumentVisibility() {\r\n        document.removeEventListener('visibilitychange', documentVisibilityListener);\r\n        documentVisibilityListener = null;\r\n    }\r\n    function createThemeAndWatchForUpdates() {\r\n        createStaticStyleOverrides();\r\n        function runDynamicStyle() {\r\n            createDynamicStyleOverrides();\r\n            watchForUpdates();\r\n        }\r\n        if (document.hidden) {\r\n            watchForDocumentVisibility(runDynamicStyle);\r\n        }\r\n        else {\r\n            runDynamicStyle();\r\n        }\r\n        changeMetaThemeColorWhenAvailable(filter);\r\n    }\r\n    function watchForUpdates() {\r\n        watchForStyleChanges(function (_a) {\r\n            var created = _a.created, updated = _a.updated, removed = _a.removed, moved = _a.moved;\r\n            var stylesToRemove = removed;\r\n            var stylesToManage = created.concat(updated).concat(moved)\r\n                .filter(function (style) { return !styleManagers.has(style); });\r\n            var stylesToRestore = moved\r\n                .filter(function (style) { return styleManagers.has(style); });\r\n            stylesToRemove.forEach(function (style) { return removeManager(style); });\r\n            var newManagers = stylesToManage\r\n                .map(function (style) { return createManager(style); });\r\n            var newVariables = newManagers\r\n                .map(function (manager) { return manager.details(); })\r\n                .filter(function (details) { return details && details.variables.size > 0; })\r\n                .map(function (_a) {\r\n                var variables = _a.variables;\r\n                return variables;\r\n            });\r\n            if (newVariables.length === 0) {\r\n                newManagers.forEach(function (manager) { return manager.render(filter, variables); });\r\n            }\r\n            else {\r\n                newVariables.forEach(function (variables) { return updateVariables(variables); });\r\n                throttledRenderAllStyles();\r\n            }\r\n            newManagers.forEach(function (manager) { return manager.watch(); });\r\n            stylesToRestore.forEach(function (style) { return styleManagers.get(style).restore(); });\r\n        });\r\n        watchForInlineStyles(function (element) {\r\n            overrideInlineStyle(element, filter);\r\n            if (element === document.documentElement) {\r\n                var rootVariables = getElementCSSVariables(document.documentElement);\r\n                if (rootVariables.size > 0) {\r\n                    updateVariables(rootVariables);\r\n                    throttledRenderAllStyles();\r\n                }\r\n            }\r\n        }, function (root) {\r\n            var inlineStyleElements = root.querySelectorAll(INLINE_STYLE_SELECTOR);\r\n            if (inlineStyleElements.length > 0) {\r\n                createShadowStaticStyleOverrides(root);\r\n                inlineStyleElements.forEach(function (el) { return overrideInlineStyle(el, filter); });\r\n            }\r\n        });\r\n        document.addEventListener('readystatechange', onReadyStateChange);\r\n    }\r\n    function stopWatchingForUpdates() {\r\n        styleManagers.forEach(function (manager) { return manager.pause(); });\r\n        stopStylePositionWatchers();\r\n        stopWatchingForStyleChanges();\r\n        stopWatchingForInlineStyles();\r\n        document.removeEventListener('readystatechange', onReadyStateChange);\r\n    }\r\n    function createOrUpdateDynamicTheme(filterConfig, dynamicThemeFixes, iframe) {\r\n        filter = filterConfig;\r\n        fixes = dynamicThemeFixes;\r\n        isIFrame = iframe;\r\n        if (document.head) {\r\n            createThemeAndWatchForUpdates();\r\n        }\r\n        else {\r\n            if (!isFirefox()) {\r\n                var fallbackStyle = createOrUpdateStyle('darkreader--fallback');\r\n                document.documentElement.appendChild(fallbackStyle);\r\n                fallbackStyle.textContent = getModifiedFallbackStyle(filter, { strict: true });\r\n            }\r\n            var headObserver_1 = new MutationObserver(function () {\r\n                if (document.head) {\r\n                    headObserver_1.disconnect();\r\n                    createThemeAndWatchForUpdates();\r\n                }\r\n            });\r\n            headObserver_1.observe(document, { childList: true, subtree: true });\r\n        }\r\n    }\r\n    function removeDynamicTheme() {\r\n        cleanDynamicThemeCache();\r\n        removeNode(document.querySelector('.darkreader--fallback'));\r\n        if (document.head) {\r\n            restoreMetaThemeColor();\r\n            removeNode(document.head.querySelector('.darkreader--user-agent'));\r\n            removeNode(document.head.querySelector('.darkreader--text'));\r\n            removeNode(document.head.querySelector('.darkreader--invert'));\r\n            removeNode(document.head.querySelector('.darkreader--inline'));\r\n            removeNode(document.head.querySelector('.darkreader--override'));\r\n        }\r\n        shadowRootsWithOverrides.forEach(function (root) {\r\n            removeNode(root.querySelector('.darkreader--inline'));\r\n        });\r\n        shadowRootsWithOverrides.clear();\r\n        Array.from(styleManagers.keys()).forEach(function (el) { return removeManager(el); });\r\n        Array.from(document.querySelectorAll('.darkreader')).forEach(removeNode);\r\n    }\r\n    function cleanDynamicThemeCache() {\r\n        stopWatchingForDocumentVisibility();\r\n        cancelRendering();\r\n        stopWatchingForUpdates();\r\n        cleanModificationCache();\r\n    }\n\n    var defaultTheme = {\r\n        mode: 1,\r\n        brightness: 100,\r\n        contrast: 100,\r\n        grayscale: 0,\r\n        sepia: 0,\r\n        useFont: false,\r\n        fontFamily: '',\r\n        textStroke: 0,\r\n        engine: ThemeEngines.dynamicTheme,\r\n        stylesheet: '',\r\n    };\r\n    var isIFrame$1 = (function () {\r\n        try {\r\n            return window.self !== window.top;\r\n        }\r\n        catch (err) {\r\n            console.warn(err);\r\n            return true;\r\n        }\r\n    })();\r\n    function enable(themeOptions, fixes) {\r\n        if (themeOptions === void 0) { themeOptions = {}; }\r\n        if (fixes === void 0) { fixes = null; }\r\n        var theme = __assign(__assign({}, defaultTheme), themeOptions);\r\n        if (theme.engine !== ThemeEngines.dynamicTheme) {\r\n            throw new Error('Theme engine is not supported');\r\n        }\r\n        createOrUpdateDynamicTheme(theme, fixes, isIFrame$1);\r\n    }\r\n    function disable() {\r\n        removeDynamicTheme();\r\n    }\r\n    var darkScheme = matchMedia('(prefers-color-scheme: dark)');\r\n    var store = {\r\n        themeOptions: null,\r\n        fixes: null,\r\n    };\r\n    function handleColorScheme() {\r\n        if (darkScheme.matches) {\r\n            enable(store.themeOptions, store.fixes);\r\n        }\r\n        else {\r\n            disable();\r\n        }\r\n    }\r\n    function auto(themeOptions, fixes) {\r\n        if (themeOptions === void 0) { themeOptions = {}; }\r\n        if (fixes === void 0) { fixes = null; }\r\n        if (themeOptions) {\r\n            store = { themeOptions: themeOptions, fixes: fixes };\r\n            handleColorScheme();\r\n            darkScheme.addListener(handleColorScheme);\r\n        }\r\n        else {\r\n            darkScheme.removeListener(handleColorScheme);\r\n            disable();\r\n        }\r\n    }\r\n    var setFetchMethod$1 = setFetchMethod;\n\n    exports.auto = auto;\n    exports.disable = disable;\n    exports.enable = enable;\n    exports.setFetchMethod = setFetchMethod$1;\n\n    Object.defineProperty(exports, '__esModule', { value: true });\n\n})));\n";var makeMarkdown=function makeMarkdown(md,highlight,darkMode){if(highlight){_marked.default.setOptions({highlight:function highlight(code){return _highlight.default.highlightAuto(code).value;}});}return"\n    <html>\n      <head>\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1, shrink-to-fit=no, maximum-scale=1.0\"/>\n        <style>"+baseCSS+"</style>\n        <style>"+mdCSS+"</style>\n        <style>"+(highlight?hljsCSS:'')+"</style>\n        <style>"+bodyCSS+"</style>\n        <style>\n          body {\n            margin: 0;\n            padding: 20px;\n            "+(darkMode?'background-color: black;':'background-color: white;')+"\n          }\n        </style>\n        "+(darkMode?"\n        <script>\n          "+darkreader+"\n        </script>\n        <script>\n          DarkReader.enable();\n        </script>\n        ":'')+"\n      </head>\n      <body>\n        <article class=\"markdown-body\">\n          "+(0,_marked.default)(md)+"\n        </article>\n      </body>\n    </html>";};var _default=makeMarkdown;exports.default=_default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWtlTWFya2Rvd24udHMiXSwibmFtZXMiOlsiaGxqc0NTUyIsImJhc2VDU1MiLCJtZENTUyIsImJvZHlDU1MiLCJkYXJrcmVhZGVyIiwibWFrZU1hcmtkb3duIiwibWQiLCJoaWdobGlnaHQiLCJkYXJrTW9kZSIsIk1hcmtlZCIsInNldE9wdGlvbnMiLCJjb2RlIiwiaGxqcyIsImhpZ2hsaWdodEF1dG8iLCJ2YWx1ZSJdLCJtYXBwaW5ncyI6Im1LQUFBLCtEQUNBLHNEQUlBLEdBQU1BLENBQUFBLE9BQU8sa3VDQUFiLENBS0EsR0FBTUMsQ0FBQUEsT0FBTyxvdElBQWIsQ0FLQSxHQUFNQyxDQUFBQSxLQUFLLG83TUFBWCxDQUtBLEdBQU1DLENBQUFBLE9BQU8sNE5BQWIsQ0FLQSxHQUFNQyxDQUFBQSxVQUFVLHV2eUlBQWhCLENBS0EsR0FBTUMsQ0FBQUEsWUFJSyxDQUFHLFFBSlJBLENBQUFBLFlBSVEsQ0FBQ0MsRUFBRCxDQUFLQyxTQUFMLENBQWdCQyxRQUFoQixDQUE2QixDQUN6QyxHQUFJRCxTQUFKLENBQWUsQ0FDYkUsZ0JBQU9DLFVBQVAsQ0FBa0IsQ0FDaEJILFNBQVMsQ0FBRSxtQkFBQ0ksSUFBRCxDQUFVLENBQ25CLE1BQU9DLG9CQUFLQyxhQUFMLENBQW1CRixJQUFuQixFQUF5QkcsS0FBaEMsQ0FDRCxDQUhlLENBQWxCLEVBS0QsQ0FFRCw0S0FJZWIsT0FKZiw2QkFLZUMsS0FMZiw4QkFNZUssU0FBUyxDQUFHUCxPQUFILENBQWEsRUFOckMsOEJBT2VHLE9BUGYsa0hBYVlLLFFBQVEsQ0FBRywwQkFBSCxDQUFnQywwQkFicEQsK0NBa0JRQSxRQUFRLGtDQUdOSixVQUhNLHNHQVNKLEVBM0JaLHlGQWdDVSxvQkFBT0UsRUFBUCxDQWhDVixvREFvQ0QsQ0FqREQsQyxhQW1EZUQsWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBobGpzIGZyb20gJ2hpZ2hsaWdodC5qcyc7XG5pbXBvcnQgTWFya2VkIGZyb20gJ21hcmtlZCc7XG5cbmRlY2xhcmUgY29uc3QgcHJldmFsOiBhbnk7XG5cbmNvbnN0IGhsanNDU1MgPSBwcmV2YWxgXG4gIGNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKVxuICBtb2R1bGUuZXhwb3J0cyA9IGZzLnJlYWRGaWxlU3luYyhyZXF1aXJlLnJlc29sdmUoJy4uL25vZGVfbW9kdWxlcy9oaWdobGlnaHQuanMvc3R5bGVzL2dpdGh1Yi5jc3MnKSwgJ3V0ZjgnKVxuYDtcblxuY29uc3QgYmFzZUNTUyA9IHByZXZhbGBcbiAgY29uc3QgZnMgPSByZXF1aXJlKCdmcycpXG4gIG1vZHVsZS5leHBvcnRzID0gZnMucmVhZEZpbGVTeW5jKHJlcXVpcmUucmVzb2x2ZSgnLi4vbm9kZV9tb2R1bGVzL0BwcmltZXIvY3NzL2Rpc3QvYmFzZS5jc3MnKSwgJ3V0ZjgnKVxuYDtcblxuY29uc3QgbWRDU1MgPSBwcmV2YWxgXG4gIGNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKVxuICBtb2R1bGUuZXhwb3J0cyA9IGZzLnJlYWRGaWxlU3luYyhyZXF1aXJlLnJlc29sdmUoJy4uL25vZGVfbW9kdWxlcy9AcHJpbWVyL2Nzcy9kaXN0L21hcmtkb3duLmNzcycpLCAndXRmOCcpXG5gO1xuXG5jb25zdCBib2R5Q1NTID0gcHJldmFsYFxuICBjb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJylcbiAgbW9kdWxlLmV4cG9ydHMgPSBmcy5yZWFkRmlsZVN5bmMocmVxdWlyZS5yZXNvbHZlKCcuL21hcmtkb3duLWJvZHkuY3NzJyksICd1dGY4JylcbmA7XG5cbmNvbnN0IGRhcmtyZWFkZXIgPSBwcmV2YWxgXG4gIGNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKVxuICBtb2R1bGUuZXhwb3J0cyA9IGZzLnJlYWRGaWxlU3luYyhyZXF1aXJlLnJlc29sdmUoJy4uL25vZGVfbW9kdWxlcy9kYXJrcmVhZGVyL2RhcmtyZWFkZXIuanMnKSwgJ3V0ZjgnKVxuYDtcblxuY29uc3QgbWFrZU1hcmtkb3duOiAoXG4gIG1kOiBzdHJpbmcsXG4gIGhpZ2hsaWdodD86IGJvb2xlYW4sXG4gIGRhcmtNb2RlPzogYm9vbGVhbixcbikgPT4gc3RyaW5nID0gKG1kLCBoaWdobGlnaHQsIGRhcmtNb2RlKSA9PiB7XG4gIGlmIChoaWdobGlnaHQpIHtcbiAgICBNYXJrZWQuc2V0T3B0aW9ucyh7XG4gICAgICBoaWdobGlnaHQ6IChjb2RlKSA9PiB7XG4gICAgICAgIHJldHVybiBobGpzLmhpZ2hsaWdodEF1dG8oY29kZSkudmFsdWU7XG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIGBcbiAgICA8aHRtbD5cbiAgICAgIDxoZWFkPlxuICAgICAgICA8bWV0YSBuYW1lPVwidmlld3BvcnRcIiBjb250ZW50PVwid2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEsIHNocmluay10by1maXQ9bm8sIG1heGltdW0tc2NhbGU9MS4wXCIvPlxuICAgICAgICA8c3R5bGU+JHtiYXNlQ1NTfTwvc3R5bGU+XG4gICAgICAgIDxzdHlsZT4ke21kQ1NTfTwvc3R5bGU+XG4gICAgICAgIDxzdHlsZT4ke2hpZ2hsaWdodCA/IGhsanNDU1MgOiAnJ308L3N0eWxlPlxuICAgICAgICA8c3R5bGU+JHtib2R5Q1NTfTwvc3R5bGU+XG4gICAgICAgIDxzdHlsZT5cbiAgICAgICAgICBib2R5IHtcbiAgICAgICAgICAgIG1hcmdpbjogMDtcbiAgICAgICAgICAgIHBhZGRpbmc6IDIwcHg7XG4gICAgICAgICAgICAke1xuICAgICAgICAgICAgICBkYXJrTW9kZSA/ICdiYWNrZ3JvdW5kLWNvbG9yOiBibGFjazsnIDogJ2JhY2tncm91bmQtY29sb3I6IHdoaXRlOydcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIDwvc3R5bGU+XG4gICAgICAgICR7XG4gICAgICAgICAgZGFya01vZGVcbiAgICAgICAgICAgID8gYFxuICAgICAgICA8c2NyaXB0PlxuICAgICAgICAgICR7ZGFya3JlYWRlcn1cbiAgICAgICAgPC9zY3JpcHQ+XG4gICAgICAgIDxzY3JpcHQ+XG4gICAgICAgICAgRGFya1JlYWRlci5lbmFibGUoKTtcbiAgICAgICAgPC9zY3JpcHQ+XG4gICAgICAgIGBcbiAgICAgICAgICAgIDogJydcbiAgICAgICAgfVxuICAgICAgPC9oZWFkPlxuICAgICAgPGJvZHk+XG4gICAgICAgIDxhcnRpY2xlIGNsYXNzPVwibWFya2Rvd24tYm9keVwiPlxuICAgICAgICAgICR7TWFya2VkKG1kKX1cbiAgICAgICAgPC9hcnRpY2xlPlxuICAgICAgPC9ib2R5PlxuICAgIDwvaHRtbD5gO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgbWFrZU1hcmtkb3duO1xuIl19